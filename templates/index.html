<!DOCTYPE html>
<html>
<head>
    <title>Pricing Calculator</title>
    <style>
        table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 6px; }
        th { background: #f0f0f0; }
    </style>
</head>
<body>
    <h1>Pricing Calculator</h1>

    {% if step == 'volumes' %}
    <form method="post">
        <input type="hidden" name="step" value="volumes">
        <label>Country:</label>
        <select name="country" id="country-select" onchange="updateMinPlatformFee()">
            <option value="India">India</option>
            <option value="MENA">MENA</option>
            <option value="LATAM">LATAM</option>
            <option value="Africa">Africa</option>
            <option value="Europe">Europe</option>
            <option value="Rest of the World">Rest of the World</option>
        </select><br><br>
        <label>AI Message Volume (per month):</label>
        <input type="number" name="ai_volume" required><br><br>
        <label>Advanced Message Volume (per month):</label>
        <input type="number" name="advanced_volume" required><br><br>
        <label>Basic Marketing Message Volume (per month):</label>
        <input type="number" name="basic_marketing_volume" required><br><br>
        <label>Basic Utility/Authentication Message Volume (per month):</label>
        <input type="number" name="basic_utility_volume" required><br><br>
        <label>Minimum Platform Fee:</label>
        <input type="text" id="min_platform_fee" name="min_platform_fee" value="" readonly><br>
        <small>This is the minimum platform fee for the selected country. It cannot be edited.</small><br><br>
        <label>BFSI Tier:</label>
        <select name="bfsi_tier">
            <option value="NA">NA</option>
            <option value="Tier 1">Tier 1</option>
            <option value="Tier 2">Tier 2</option>
            <option value="Tier 3">Tier 3</option>
        </select><br><br>
        <label>Personalize Load:</label>
        <select name="personalize_load">
            <option value="NA">NA</option>
            <option value="Standard">Standard</option>
            <option value="Advanced">Advanced</option>
        </select><br><br>
        <label>Number of Human Agents (Agent Assist):</label>
        <select name="human_agents">
            <option value="NA">NA</option>
            <option value="20+">20+</option>
            <option value="50+">50+</option>
            <option value="100+">100+</option>
        </select><br><br>
        <label>AI Module (Yes/No):</label>
        <select name="ai_module">
            <option value="NA">NA</option>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
        </select><br><br>
        <input type="submit" value="Next: Rate Card">
    </form>
    <script>
    function updateMinPlatformFee() {
        var country = document.getElementById('country-select').value;
        var minFee = '';
        if (country === 'India') minFee = 'INR 100000';
        else if (country === 'Africa' || country === 'Rest of the World') minFee = 'USD 500';
        else minFee = 'USD 1000';
        document.getElementById('min_platform_fee').value = minFee;
    }
    window.onload = updateMinPlatformFee;
    </script>
    {% endif %}

    {% if step == 'prices' %}
    <form method="post">
        <input type="hidden" name="step" value="prices">
        <h2>Rate Card Gupshup Fee on top of channel costs(edit if needed)</h2>
        <label>Platform Fee (editable):</label>
        {{ currency_symbol }}<input type="number" name="platform_fee" value="{{ platform_fee }}" required><br>
        <small>This is the calculated platform fee based on your selections. You can edit it if needed.</small><br><br>
        <label>AI Message Rate Card:</label>
        {{ currency_symbol }}<input type="number" step="0.0001" name="ai_price" value="{{ suggested.ai_price }}" required><br><br>
        <label>Advanced Message Rate Card:</label>
        {{ currency_symbol }}<input type="number" step="0.0001" name="advanced_price" value="{{ suggested.advanced_price }}" required><br><br>
        <label>Basic Marketing Message Rate Card:</label>
        {{ currency_symbol }}<input type="number" step="0.0001" name="basic_marketing_price" value="{{ suggested.basic_marketing_price }}" required><br><br>
        <label>Basic Utility/Authentication Message Rate Card:</label>
        {{ currency_symbol }}<input type="number" step="0.0001" name="basic_utility_price" value="{{ suggested.basic_utility_price }}" required><br><br>
        <input type="submit" value="Calculate Results">
    </form>
    <form method="get">
        <input type="submit" value="Back to Volumes">
    </form>
    {% endif %}

    {% if step == 'results' %}
        <h2>Results</h2>
        <table>
            <tr>
                <th>Line Item</th>
                <th>Volume</th>
                <th>Chosen Price/message</th>
                <th>Rate Card Price/message</th>
                <th>Overage Price/message</th>
                <th>Revenue (Chosen) {{ currency_symbol }}/month</th>
                <th>Revenue (Rate Card) {{ currency_symbol }}/month</th>
            </tr>
            {% for item in results.line_items %}
            <tr>
                <td>{{ item.label }}</td>
                <td>{{ item.volume }}</td>
                <td>{{ item.chosen_price }}</td>
                <td>{{ item.suggested_price }}</td>
                <td>{{ item.overage_price }}</td>
                <td>{{ item.revenue|round(2) }}</td>
                <td>{{ item.suggested_revenue|round(2) }}</td>
            </tr>
            {% endfor %}
        </table>
        <br>
        <table>
            <tr>
                <th>Platform Fee Section</th>
                <th>Value</th>
                <th>Inclusions</th>
            </tr>
            <tr>
                <td>Platform Fee Used for Margin Calculation</td>
                <td>{{ chosen_platform_fee }}</td>
                <td>
                    <ul>
                    {% for inc in inclusions['Platform Fee Used for Margin Calculation'] %}
                        <li>{{ inc }}</li>
                    {% endfor %}
                    </ul>
                </td>
            </tr>
            <tr>
                <td>Rate Card Platform Fee</td>
                <td>{{ rate_card_platform_fee }}</td>
                <td></td>
            </tr>
            {% for label, value in user_selections %}
                {% if label == 'BFSI Tier' and value in ['Tier 1', 'Tier 2', 'Tier 3'] %}
                <tr>
                    <td>BFSI {{ value }}</td>
                    <td>Included</td>
                    <td>
                        <ul>
                        {% for inc in inclusions['BFSI Tier ' ~ value.split(' ')[-1]] %}
                            <li>{{ inc }}</li>
                        {% endfor %}
                        </ul>
                    </td>
                </tr>
                {% endif %}
                {% if label == 'Personalize Load' and value in ['Standard', 'Advanced'] %}
                <tr>
                    <td>Personalize Load {{ value }}</td>
                    <td>Included</td>
                    <td>
                        <ul>
                        {% for inc in inclusions['Personalize Load ' ~ value] %}
                            <li>{{ inc }}</li>
                        {% endfor %}
                        </ul>
                    </td>
                </tr>
                {% endif %}
                {% if label == 'AI Module' and value == 'Yes' %}
                <tr>
                    <td>AI Module</td>
                    <td>Included</td>
                    <td>
                        <ul>
                        {% for inc in inclusions['AI Module Yes'] %}
                            <li>{{ inc }}</li>
                        {% endfor %}
                        </ul>
                    </td>
                </tr>
                {% endif %}
                {% if label == 'Human Agents' and value in ['20+', '50+', '100+'] %}
                <tr>
                    <td>Human Agents {{ value }}</td>
                    <td>Included</td>
                    <td></td>
                </tr>
                {% endif %}
            {% endfor %}
        </table>
        <br>
        <table>
            <tr><td colspan="3"><small>Note: Margin is calculated using the chosen platform fee (editable in the previous step).</small></td></tr>
            <tr><th>Total Revenue (Chosen) {{ currency_symbol }}/month</th><td colspan="2">{{ results.revenue }}</td></tr>
            <tr><th>Total Revenue (Rate Card) {{ currency_symbol }}/month</th><td colspan="2">{{ results.suggested_revenue }}</td></tr>
            <tr><th>Channel Cost</th><td colspan="2">{{ results.channel_cost }}</td></tr>
            <tr><th>AI Costs {{ currency_symbol }}/month</th><td colspan="2">{{ results.ai_costs }}</td></tr>
            <tr><th>Total Costs {{ currency_symbol }}/month</th><td colspan="2">{{ results.total_costs }}</td></tr>
            <tr><th>Margin (User Chosen)</th><td colspan="2">{{ results.margin }}</td></tr>
            <tr><th>Margin (Rate Card)</th><td colspan="2">{{ results.suggested_margin }}</td></tr>
        </table>
        <br>
        <form method="get">
            <input type="submit" value="Start Over">
        </form>
    {% endif %}
</body>
</html>