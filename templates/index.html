<!DOCTYPE html>
<html>
<head>
    <title>Pricing Calculator</title>
    <style>
        body { font-family: 'Segoe UI', 'Arial', 'sans-serif'; }
        h2, h3, h4 { font-weight: bold; margin-top: 1.5em; }
        h2 { font-size: 2em; }
        h3 { font-size: 1.5em; }
        h4 { font-size: 1.2em; }
        .section { margin-bottom: 2em; }
        hr { border: none; border-top: 1px solid #ccc; margin: 2em 0; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 1.5em; }
        table tr:nth-child(even) { background-color: #f9f9f9; }
        table tr:nth-child(odd) { background-color: #fff; }
        table th, table td { padding: 8px 12px; }
        th { background: #f0f0f0; }
        td, th { text-align: right; }
        th:first-child, td:first-child { text-align: left; }
        label { display: block; margin-top: 0.4em; margin-bottom: 0.1em; font-weight: 500; }
        input, select { margin-top: 0.1em; margin-bottom: 0.3em; }
        .key-number { font-weight: bold; font-size: 1.1em; }
        .flashes {
          list-style: none;
          padding: 0;
          margin: 1em 0;
        }
        .flashes li {
          background: #ffe0e0;
          color: #b30000;
          border: 1px solid #b30000;
          padding: 10px 16px;
          margin-bottom: 8px;
          font-weight: bold;
          border-radius: 4px;
        }
        .flashes li.error {
          background: #ffe0e0;
          color: #b30000;
          border: 1px solid #b30000;
        }
        .flashes li.success {
          background: #e0ffe0;
          color: #006600;
          border: 1px solid #006600;
        }
    </style>
    <script>
    // Global function for adding commas to numbers
    function addCommas(nStr) {
        nStr = nStr.replace(/,/g, '');
        if (nStr === '') return '';
        var parts = nStr.split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return parts.join('.');
    }
    </script>
</head>
<body>
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flashes">
          {% for category, message in messages %}
            <li class="{{ category }}">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}
    <h1>Pricing Calculator</h1>

    {% if step == 'volumes' %}
    <div style="display: flex; flex-direction: row; align-items: flex-start;">
      <div style="flex: 1; min-width: 0;">
        <form method="post" id="volumes-form">
            <input type="hidden" name="step" value="volumes">
            <label>Country:</label>
            <select name="country" id="country-select" onchange="updateMinPlatformFee()">
                <option value="India" {% if inputs and inputs.country == 'India' %}selected{% endif %}>India</option>
                <option value="MENA" {% if inputs and inputs.country == 'MENA' %}selected{% endif %}>MENA</option>
                <option value="LATAM" {% if inputs and inputs.country == 'LATAM' %}selected{% endif %}>LATAM</option>
                <option value="Africa" {% if inputs and inputs.country == 'Africa' %}selected{% endif %}>Africa</option>
                <option value="Europe" {% if inputs and inputs.country == 'Europe' %}selected{% endif %}>Europe</option>
                <option value="Rest of the World" {% if inputs and inputs.country == 'Rest of the World' %}selected{% endif %}>Rest of the World</option>
            </select><br><br>
            <label>AI Message Volume (per month):</label>
            <input type="text" name="ai_volume" class="comma-number" value="{{ inputs.ai_volume if inputs and inputs.ai_volume is defined else '' }}"><br><br>
            <label>Advanced Message Volume (per month):</label>
            <input type="text" name="advanced_volume" class="comma-number" value="{{ inputs.advanced_volume if inputs and inputs.advanced_volume is defined else '' }}"><br><br>
            <label>Basic Marketing Message Volume (per month):</label>
            <input type="text" name="basic_marketing_volume" class="comma-number" value="{{ inputs.basic_marketing_volume if inputs and inputs.basic_marketing_volume is defined else '' }}"><br><br>
            <label>Basic Utility/Authentication Message Volume (per month):</label>
            <input type="text" name="basic_utility_volume" class="comma-number" value="{{ inputs.basic_utility_volume if inputs and inputs.basic_utility_volume is defined else '' }}"><br><br>
            <label>Minimum Platform Fee:</label>
            <input type="text" id="min_platform_fee" name="min_platform_fee" value="" readonly><br>
            <small>80 TPS, Journey Builder Lite, Campaign Manager, CTWA - (Meta/Tiktok), Agent Assist < 20 Agents, Personalize upto 1 Million profiles and external events not supported</small><br><br>
            <label>Personalize Load:</label>
            <select name="personalize_load">
                <option value="NA" {% if inputs and inputs.personalize_load == 'NA' %}selected{% endif %}>NA</option>
                <option value="Standard" {% if inputs and inputs.personalize_load == 'Standard' %}selected{% endif %}>Standard - upto 5 million records, no external events</option>
                <option value="Advanced" {% if inputs and inputs.personalize_load == 'Advanced' %}selected{% endif %}>Advanced - 10 million records, external events supported</option>
            </select><br>
            <small>If the client requires large number of profiles and support for external events, select the appropriate tier.</small><br><br>
            <label>BFSI Tier:</label>
            <select name="bfsi_tier">
                <option value="NA" {% if inputs and inputs.bfsi_tier == 'NA' %}selected{% endif %}>NA</option>
                <option value="Tier 1" {% if inputs and inputs.bfsi_tier == 'Tier 1' %}selected{% endif %}>Tier 1</option>
                <option value="Tier 2" {% if inputs and inputs.bfsi_tier == 'Tier 2' %}selected{% endif %}>Tier 2</option>
                <option value="Tier 3" {% if inputs and inputs.bfsi_tier == 'Tier 3' %}selected{% endif %}>Tier 3</option>
            </select><br>
            <small>Each tier comes with specific controls of privacy and security requirements. The exact inclusions of each tier will be displayed on the final pricing page.</small><br><br>
            <label>AI Module (Yes/No):</label>
            <select name="ai_module">
                <option value="NA" {% if inputs and inputs.ai_module == 'NA' %}selected{% endif %}>NA</option>
                <option value="Yes" {% if inputs and inputs.ai_module == 'Yes' %}selected{% endif %}>Yes</option>
                <option value="No" {% if inputs and inputs.ai_module == 'No' %}selected{% endif %}>No</option>
            </select><br>
            <small>Access to Workspace Configuration and data retraining screens</small><br><br>
            <label>Smart CPaaS:</label>
            <select name="smart_cpaas">
                <option value="No" {% if inputs and inputs.smart_cpaas == 'No' %}selected{% endif %}>No</option>
                <option value="Yes" {% if inputs and inputs.smart_cpaas == 'Yes' %}selected{% endif %}>Yes</option>
            </select><br>
            <small>Auto failover between channels</small><br><br>
            <label>Increased TPS:</label>
            <select name="increased_tps">
                <option value="NA" {% if inputs and inputs.increased_tps == 'NA' %}selected{% endif %}>NA</option>
                <option value="250" {% if inputs and inputs.increased_tps == '250' %}selected{% endif %}>250 (upto 250 Messages per Second)</option>
                <option value="1000" {% if inputs and inputs.increased_tps == '1000' %}selected{% endif %}>1000 (upto 1000 Messages per Second)</option>
            </select><br>
            <small>Required to support high volume campaigns</small><br><br>
            <label>Number of Human Agents (Agent Assist):</label>
            <select name="human_agents">
                <option value="NA" {% if inputs and inputs.human_agents == 'NA' %}selected{% endif %}>NA</option>
                <option value="20+" {% if inputs and inputs.human_agents == '20+' %}selected{% endif %}>20+</option>
                <option value="50+" {% if inputs and inputs.human_agents == '50+' %}selected{% endif %}>50+</option>
                <option value="100+" {% if inputs and inputs.human_agents == '100+' %}selected{% endif %}>100+</option>
            </select><br><br>
            <input type="submit" value="Next: Rate Card">
        </form>
      </div>
      <aside style="width: 340px; margin-left: 32px; background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 24px 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); position: sticky; top: 32px;">
        <h3 style="margin-top: 0;">How to Use This Calculator</h3>
        <ol style="font-size: 1em; padding-left: 1.2em;">
          <li>Enter your <b>country</b> and (optionally) message volumes for each type.</li>
          <li>Select platform fee options and other requirements.</li>
          <li>Click <b>Next: Rate Card</b> to review and edit suggested prices.</li>
          <li>Proceed to <b>Bundle</b> or <b>Committed Amount</b> step as needed.</li>
          <li>View your detailed pricing breakdown and inclusions.</li>
        </ol>
        <p style="margin-top: 1.5em; font-size: 0.97em; color: #555;">You can leave message volumes blank if you only want to set a platform fee or get a quote based on committed spend.</p>
        <a href="#" style="font-size: 0.97em; color: #007bff; text-decoration: underline;">Learn more</a>
      </aside>
    </div>
    <script>
    function updateMinPlatformFee() {
        var country = document.getElementById('country-select').value;
        var minFee = '';
        if (country === 'India') minFee = 'INR 100000';
        else if (country === 'Africa' || country === 'Rest of the World') minFee = 'USD 500';
        else minFee = 'USD 1000';
        document.getElementById('min_platform_fee').value = minFee;
    }
    window.onload = updateMinPlatformFee;
    
    // Format input with commas as user types
    document.querySelectorAll('.comma-number').forEach(function(input) {
        input.addEventListener('input', function(e) {
            var cursor = input.selectionStart;
            var oldLength = input.value.length;
            input.value = addCommas(input.value);
            var newLength = input.value.length;
            input.selectionEnd = cursor + (newLength - oldLength);
        });
    });
    // Remove commas before submit
    document.getElementById('volumes-form').addEventListener('submit', function(e) {
        document.querySelectorAll('.comma-number').forEach(function(input) {
            input.value = input.value.replace(/,/g, '');
        });
    });
    </script>
    {% endif %}

    {% if step == 'prices' %}
    <form method="post" id="prices-form">
        <input type="hidden" name="step" value="prices">
        <h2>Rate Card Gupshup Fee on top of channel costs(edit if needed)</h2>
        <label>Platform Fee (editable):</label>
        {{ currency_symbol }}<input type="text" name="platform_fee" class="comma-number" value="{{ platform_fee }}" required><br>
        <small>This is the calculated platform fee based on your selections. You can edit it if needed.</small><br><br>
        <label>AI Message Rate Card:</label>
        {{ currency_symbol }}<input type="text" name="ai_price" class="comma-number" value="{{ suggested.ai_price }}" required><br><br>
        <label>Advanced Message Rate Card:</label>
        {{ currency_symbol }}<input type="text" name="advanced_price" class="comma-number" value="{{ suggested.advanced_price }}" required><br><br>
        <label>Basic Marketing Message Rate Card:</label>
        {{ currency_symbol }}<input type="text" name="basic_marketing_price" class="comma-number" value="{{ suggested.basic_marketing_price }}" required><br><br>
        <label>Basic Utility/Authentication Message Rate Card:</label>
        {{ currency_symbol }}<input type="text" name="basic_utility_price" class="comma-number" value="{{ suggested.basic_utility_price }}" required><br><br>
        <input type="submit" value="Calculate Results">
    </form>
    <form method="get">
        <input type="submit" value="Back to Volumes">
    </form>
    <script>
    // Format input with commas as user types
    document.querySelectorAll('.comma-number').forEach(function(input) {
        input.addEventListener('input', function(e) {
            var cursor = input.selectionStart;
            var oldLength = input.value.length;
            input.value = addCommas(input.value);
            var newLength = input.value.length;
            input.selectionEnd = cursor + (newLength - oldLength);
        });
    });
    // Remove commas before submit
    document.getElementById('prices-form').addEventListener('submit', function(e) {
        document.querySelectorAll('.comma-number').forEach(function(input) {
            input.value = input.value.replace(/,/g, '');
        });
    });
    </script>
    {% endif %}

    {% if step == 'bundle' %}
    {% set all_volumes_zero = (inputs.ai_volume|float == 0 and inputs.advanced_volume|float == 0 and inputs.basic_marketing_volume|float == 0 and inputs.basic_utility_volume|float == 0) %}
    <form method="post">
        {% if all_volumes_zero %}
        <h2>Enter Committed Monthly Amount</h2>
        <p>You have not entered any message volumes. Please enter the amount you wish to commit per month. This amount will be drawn down as you use the platform, based on the agreed rates for each message type.</p>
        <label>Committed Amount ({{ currency_symbol }}):</label>
        <input type="text" name="committed_amount" class="comma-number" required><br><br>
        {% else %}
        <h2>Create a Messaging Bundle?</h2>
        <p>Would you like to create a messaging bundle and lock in a fixed price for your monthly messaging volume?</p>
        <label>
            <input type="radio" name="bundle_choice" value="Yes" required> Yes
        </label>
        <label>
            <input type="radio" name="bundle_choice" value="No" required> No
        </label>
        <br><br>
        {% endif %}
        <input type="hidden" name="step" value="bundle">
        <input type="submit" value="Continue">
    </form>
    {% endif %}

    {% if step == 'results' %}
        <!-- Section 1: Pricing -->
        <div style="max-width: 1100px; margin: 0 auto;">
          <h2 style="margin-top:0;">Section 1: Pricing</h2>
          <!-- Pricing Table -->
          <div style="margin-bottom: 24px;">
            <table style="border-collapse: collapse; width: 100%; font-size: 1.05em;">
              <thead>
                <tr style="background: #f0f4f8;">
                  <th style="text-align:left;">Line Item</th>
                  <th style="text-align:right;">Volume</th>
                  <th style="text-align:right;">Chosen Price/message</th>
                  <th style="text-align:right;">Overage Price/message</th>
                  <th style="text-align:right;">Fixed Price</th>
                </tr>
              </thead>
              <tbody>
              {% for row in pricing_table %}
                  <tr>
                      <td>{{ row.line_item or row.label }}</td>
                      <td class="right">{{ row.volume }}</td>
                      <td class="right">{{ row.chosen_price }}</td>
                      <td class="right">{{ row.overage_price }}</td>
                      <td class="right">
                          {% if row.line_item == 'Platform Fee (Chosen)' %}
                              {{ currency_symbol }}{{ '{:,.0f}'.format(row.revenue or 0) if ((row.revenue or 0) % 1) == 0 else '{:,.2f}'.format(row.revenue or 0) }}
                              {% if user_selections and user_selections|length > 0 %}<br>
                                  <span style="font-size:0.92em; color:#888;">
                                      {% for label, value in user_selections %}
                                          {{ label }}: {{ value }}{% if not loop.last %}, {% endif %}
                                      {% endfor %}
                                  </span>
                              {% endif %}
                          {% elif row.line_item == 'Committed Amount' %}
                              {{ currency_symbol }}{{ '{:,.0f}'.format(row.revenue or 0) if ((row.revenue or 0) % 1) == 0 else '{:,.2f}'.format(row.revenue or 0) }}
                          {% else %}
                              &nbsp;
                          {% endif %}
                      </td>
                  </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
          <!-- Inclusions -->
          <div style="margin-bottom: 18px;">
            <h3 style="margin-bottom: 8px;">Inclusions</h3>
            <ul style="margin:0 0 0 18px; padding:0; font-size:1.08em;">
              {% for inc in final_inclusions %}
                <li style="margin-bottom:2px;">{{ inc }}</li>
              {% endfor %}
            </ul>
          </div>
          <!-- Expected Invoice Amount block -->
          <div style="background: #f5f7fa; border: 1.5px solid #dbe2ea; border-radius: 8px; padding: 18px 28px; margin-bottom: 24px; display: flex; align-items: center;">
            <div style="flex:1;">
              <h2 style="margin:0; font-size: 1.3em;">Expected Invoice Amount = Meta Cost + Messaging Bundle + Platform Cost</h2>
              <div style="font-size: 2em; font-weight: bold; color: #1a2a3a; margin-top: 2px;">{{ currency_symbol }}{{ '{:,.0f}'.format(expected_invoice_amount or 0) if ((expected_invoice_amount or 0) % 1) == 0 else '{:,.2f}'.format(expected_invoice_amount or 0) }}</div>
            </div>
            {% if bundle_details and bundle_details.committed_amount is defined %}
            <div style="background: #eaf6ff; border-left: 4px solid #2196f3; padding: 12px 18px; border-radius: 6px; margin-left: 32px; font-size: 1.08em;">
              <b>Committed Deal:</b> Bundle Commitment + Platform Fee<br>
              <span style="color:#333;">Your committed amount will be drawn down as you use the platform, based on the agreed rates for each message type. Overage prices apply if you exceed the commitment.</span>
            </div>
            {% endif %}
          </div>
        </div>
        <!-- Section 2: Internal - Not to be shared -->
        <div style="max-width: 1100px; margin: 0 auto;">
          <div style="background: #f8f8fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 18px 24px; margin-top: 32px;">
            <h2 style="margin-top:0; color:#444;">Section 2: Internal - Not to be shared</h2>
            <table style="border-collapse: collapse; width: 100%; font-size: 1.05em;">
              <thead>
                <tr style="background: #f0f4f8;">
                  <th style="text-align:left;">Item</th>
                  <th style="text-align:right;">Chosen Price</th>
                  <th style="text-align:right;">Rate Card Price</th>
                  <th style="text-align:right;">Margin Change (%)</th>
                </tr>
              </thead>
              <tbody>
                {% for row in pricing_table %}
                  {% if row.line_item or row.label in ['AI Message', 'Advanced Message', 'Basic Marketing Message', 'Basic Utility/Authentication Message'] %}
                    {% if row.line_item != 'Platform Fee (Chosen)' %}
                    <tr>
                      <td>{{ row.line_item or row.label }}</td>
                      <td class="right">{{ currency_symbol }}{{ row.chosen_price }}</td>
                      <td class="right">{{ currency_symbol }}{{ row.suggested_price if row.suggested_price is defined else 'N/A' }}</td>
                      <td class="right">
                        {% if row.chosen_price and row.suggested_price and row.suggested_price|float != 0 %}
                          {{ '{:.2f}'.format(((row.chosen_price|float - row.suggested_price|float) / row.suggested_price|float) * 100) }}%
                        {% else %}
                          N/A
                        {% endif %}
                      </td>
                    </tr>
                    {% endif %}
                  {% endif %}
                {% endfor %}
                <tr>
                  <td>Platform Fee</td>
                  <td class="right">{{ currency_symbol }}{{ '{:,.0f}'.format(chosen_platform_fee or 0) }}</td>
                  <td class="right">{{ currency_symbol }}{{ '{:,.0f}'.format(rate_card_platform_fee or 0) }}</td>
                  <td class="right">
                    {% if chosen_platform_fee and rate_card_platform_fee and rate_card_platform_fee != 0 %}
                      {{ '{:.2f}'.format(((chosen_platform_fee - rate_card_platform_fee) / rate_card_platform_fee) * 100) }}%
                    {% else %}
                      N/A
                    {% endif %}
                  </td>
                </tr>
                {% if bundle_details and bundle_details.committed_amount is defined %}
                <tr>
                  <td>Committed Amount</td>
                  <td class="right">{{ currency_symbol }}{{ '{:,.0f}'.format(bundle_details.committed_amount or 0) }}</td>
                  <td class="right">N/A</td>
                  <td class="right">N/A</td>
                </tr>
                {% endif %}
              </tbody>
            </table>
            <div style="font-size:1.08em; margin-top:12px;">
              <b>Note:</b> This section is for internal use only and should not be shared with the customer.
            </div>
            {% if results.margin and (inputs.ai_volume|float > 0 or inputs.advanced_volume|float > 0 or inputs.basic_marketing_volume|float > 0 or inputs.basic_utility_volume|float > 0) %}
            <div style="font-size:1.15em; margin-top:18px; color:#1a2a3a;">
              <b>Total Margin (as per formula above):</b> {{ results.margin }}
            </div>
            {% endif %}
          </div>
        </div>
        <form method="get" action="/" style="margin-top: 32px; text-align: center;">
            <input type="submit" value="Start Over">
        </form>
    {% endif %}

    {% if step != 'volumes' %}
    <form method="post" style="display:inline;" onsubmit="event.preventDefault(); alert('Coming soon'); return false;">
        <input type="hidden" name="step" value="volumes">
        <input type="submit" value="Edit Volumes" disabled style="opacity:0.5; cursor:not-allowed;">
    </form>
    {% endif %}
    {% if step != 'prices' %}
    <form method="post" style="display:inline;" onsubmit="event.preventDefault(); alert('Coming soon'); return false;">
        <input type="hidden" name="step" value="prices">
        <input type="submit" value="Edit Prices" disabled style="opacity:0.5; cursor:not-allowed;">
    </form>
    {% endif %}
</body>
</html>