<!DOCTYPE html>
<html>
<head>
    <title>Pricing Calculator</title>
    <style>
        body { font-family: 'Segoe UI', 'Arial', 'sans-serif'; }
        h2, h3, h4 { font-weight: bold; margin-top: 1.5em; }
        h2 { font-size: 2em; }
        h3 { font-size: 1.5em; }
        h4 { font-size: 1.2em; }
        .section { margin-bottom: 2em; }
        hr { border: none; border-top: 1px solid #ccc; margin: 2em 0; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 1.5em; }
        table tr:nth-child(even) { background-color: #f9f9f9; }
        table tr:nth-child(odd) { background-color: #fff; }
        table th, table td { padding: 8px 12px; }
        th { background: #f0f0f0; }
        td, th { text-align: right; }
        th:first-child, td:first-child { text-align: left; }
        label { display: block; margin-top: 0.4em; margin-bottom: 0.1em; font-weight: 500; }
        input, select { margin-top: 0.1em; margin-bottom: 0.3em; }
        .key-number { font-weight: bold; font-size: 1.1em; }
        .flashes {
          list-style: none;
          padding: 0;
          margin: 1em 0;
        }
        .flashes li {
          background: #ffe0e0;
          color: #b30000;
          border: 1px solid #b30000;
          padding: 10px 16px;
          margin-bottom: 8px;
          font-weight: bold;
          border-radius: 4px;
        }
        .flashes li.error {
          background: #ffe0e0;
          color: #b30000;
          border: 1px solid #b30000;
        }
        .flashes li.success {
          background: #e0ffe0;
          color: #006600;
          border: 1px solid #006600;
        }
    </style>
    <script>
    // Global function for adding commas to numbers
    function addCommas(nStr) {
        nStr = nStr.replace(/,/g, '');
        if (nStr === '') return '';
        var parts = nStr.split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return parts.join('.');
    }
    </script>
</head>
<body>
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flashes">
          {% for category, message in messages %}
            <li class="{{ category }}">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}
    <h1>Pricing Calculator</h1>

    {% if step == 'volumes' %}
    <form method="post" id="volumes-form">
        <input type="hidden" name="step" value="volumes">
        <label>Country:</label>
        <select name="country" id="country-select" onchange="updateMinPlatformFee()">
            <option value="India" {% if inputs and inputs.country == 'India' %}selected{% endif %}>India</option>
            <option value="MENA" {% if inputs and inputs.country == 'MENA' %}selected{% endif %}>MENA</option>
            <option value="LATAM" {% if inputs and inputs.country == 'LATAM' %}selected{% endif %}>LATAM</option>
            <option value="Africa" {% if inputs and inputs.country == 'Africa' %}selected{% endif %}>Africa</option>
            <option value="Europe" {% if inputs and inputs.country == 'Europe' %}selected{% endif %}>Europe</option>
            <option value="Rest of the World" {% if inputs and inputs.country == 'Rest of the World' %}selected{% endif %}>Rest of the World</option>
        </select><br><br>
        <label>AI Message Volume (per month):</label>
        <input type="text" name="ai_volume" class="comma-number" required value="{{ inputs.ai_volume if inputs and inputs.ai_volume is defined else '' }}"><br><br>
        <label>Advanced Message Volume (per month):</label>
        <input type="text" name="advanced_volume" class="comma-number" required value="{{ inputs.advanced_volume if inputs and inputs.advanced_volume is defined else '' }}"><br><br>
        <label>Basic Marketing Message Volume (per month):</label>
        <input type="text" name="basic_marketing_volume" class="comma-number" required value="{{ inputs.basic_marketing_volume if inputs and inputs.basic_marketing_volume is defined else '' }}"><br><br>
        <label>Basic Utility/Authentication Message Volume (per month):</label>
        <input type="text" name="basic_utility_volume" class="comma-number" required value="{{ inputs.basic_utility_volume if inputs and inputs.basic_utility_volume is defined else '' }}"><br><br>
        <label>Minimum Platform Fee:</label>
        <input type="text" id="min_platform_fee" name="min_platform_fee" value="" readonly><br>
        <small>80 TPS, Journey Builder Lite, Campaign Manager, CTWA - (Meta/Tiktok), Agent Assist < 20 Agents, Personalize upto 1 Million profiles and external events not supported</small><br><br>
        <label>Personalize Load:</label>
        <select name="personalize_load">
            <option value="NA" {% if inputs and inputs.personalize_load == 'NA' %}selected{% endif %}>NA</option>
            <option value="Standard" {% if inputs and inputs.personalize_load == 'Standard' %}selected{% endif %}>Standard - upto 5 million records, no external events</option>
            <option value="Advanced" {% if inputs and inputs.personalize_load == 'Advanced' %}selected{% endif %}>Advanced - 10 million records, external events supported</option>
        </select><br>
        <small>If the client requires large number of profiles and support for external events, select the appropriate tier.</small><br><br>
        <label>BFSI Tier:</label>
        <select name="bfsi_tier">
            <option value="NA" {% if inputs and inputs.bfsi_tier == 'NA' %}selected{% endif %}>NA</option>
            <option value="Tier 1" {% if inputs and inputs.bfsi_tier == 'Tier 1' %}selected{% endif %}>Tier 1</option>
            <option value="Tier 2" {% if inputs and inputs.bfsi_tier == 'Tier 2' %}selected{% endif %}>Tier 2</option>
            <option value="Tier 3" {% if inputs and inputs.bfsi_tier == 'Tier 3' %}selected{% endif %}>Tier 3</option>
        </select><br>
        <small>Each tier comes with specific controls of privacy and security requirements. The exact inclusions of each tier will be displayed on the final pricing page.</small><br><br>
        <label>AI Module (Yes/No):</label>
        <select name="ai_module">
            <option value="NA" {% if inputs and inputs.ai_module == 'NA' %}selected{% endif %}>NA</option>
            <option value="Yes" {% if inputs and inputs.ai_module == 'Yes' %}selected{% endif %}>Yes</option>
            <option value="No" {% if inputs and inputs.ai_module == 'No' %}selected{% endif %}>No</option>
        </select><br>
        <small>Access to Workspace Configuration and data retraining screens</small><br><br>
        <label>Smart CPaaS:</label>
        <select name="smart_cpaas">
            <option value="No" {% if inputs and inputs.smart_cpaas == 'No' %}selected{% endif %}>No</option>
            <option value="Yes" {% if inputs and inputs.smart_cpaas == 'Yes' %}selected{% endif %}>Yes</option>
        </select><br>
        <small>Auto failover between channels</small><br><br>
        <label>Increased TPS:</label>
        <select name="increased_tps">
            <option value="NA" {% if inputs and inputs.increased_tps == 'NA' %}selected{% endif %}>NA</option>
            <option value="250" {% if inputs and inputs.increased_tps == '250' %}selected{% endif %}>250 (upto 250 Messages per Second)</option>
            <option value="1000" {% if inputs and inputs.increased_tps == '1000' %}selected{% endif %}>1000 (upto 1000 Messages per Second)</option>
        </select><br>
        <small>Required to support high volume campaigns</small><br><br>
        <label>Number of Human Agents (Agent Assist):</label>
        <select name="human_agents">
            <option value="NA" {% if inputs and inputs.human_agents == 'NA' %}selected{% endif %}>NA</option>
            <option value="20+" {% if inputs and inputs.human_agents == '20+' %}selected{% endif %}>20+</option>
            <option value="50+" {% if inputs and inputs.human_agents == '50+' %}selected{% endif %}>50+</option>
            <option value="100+" {% if inputs and inputs.human_agents == '100+' %}selected{% endif %}>100+</option>
        </select><br><br>
        <input type="submit" value="Next: Rate Card">
    </form>
    <script>
    function updateMinPlatformFee() {
        var country = document.getElementById('country-select').value;
        var minFee = '';
        if (country === 'India') minFee = 'INR 100000';
        else if (country === 'Africa' || country === 'Rest of the World') minFee = 'USD 500';
        else minFee = 'USD 1000';
        document.getElementById('min_platform_fee').value = minFee;
    }
    window.onload = updateMinPlatformFee;
    
    // Format input with commas as user types
    document.querySelectorAll('.comma-number').forEach(function(input) {
        input.addEventListener('input', function(e) {
            var cursor = input.selectionStart;
            var oldLength = input.value.length;
            input.value = addCommas(input.value);
            var newLength = input.value.length;
            input.selectionEnd = cursor + (newLength - oldLength);
        });
    });
    // Remove commas before submit
    document.getElementById('volumes-form').addEventListener('submit', function(e) {
        document.querySelectorAll('.comma-number').forEach(function(input) {
            input.value = input.value.replace(/,/g, '');
        });
    });
    </script>
    {% endif %}

    {% if step == 'prices' %}
    <form method="post" id="prices-form">
        <input type="hidden" name="step" value="prices">
        <h2>Rate Card Gupshup Fee on top of channel costs(edit if needed)</h2>
        <label>Platform Fee (editable):</label>
        {{ currency_symbol }}<input type="text" name="platform_fee" class="comma-number" value="{{ platform_fee }}" required><br>
        <small>This is the calculated platform fee based on your selections. You can edit it if needed.</small><br><br>
        <label>AI Message Rate Card:</label>
        {{ currency_symbol }}<input type="text" name="ai_price" class="comma-number" value="{{ suggested.ai_price }}" required><br><br>
        <label>Advanced Message Rate Card:</label>
        {{ currency_symbol }}<input type="text" name="advanced_price" class="comma-number" value="{{ suggested.advanced_price }}" required><br><br>
        <label>Basic Marketing Message Rate Card:</label>
        {{ currency_symbol }}<input type="text" name="basic_marketing_price" class="comma-number" value="{{ suggested.basic_marketing_price }}" required><br><br>
        <label>Basic Utility/Authentication Message Rate Card:</label>
        {{ currency_symbol }}<input type="text" name="basic_utility_price" class="comma-number" value="{{ suggested.basic_utility_price }}" required><br><br>
        <input type="submit" value="Calculate Results">
    </form>
    <form method="get">
        <input type="submit" value="Back to Volumes">
    </form>
    <script>
    // Format input with commas as user types
    document.querySelectorAll('.comma-number').forEach(function(input) {
        input.addEventListener('input', function(e) {
            var cursor = input.selectionStart;
            var oldLength = input.value.length;
            input.value = addCommas(input.value);
            var newLength = input.value.length;
            input.selectionEnd = cursor + (newLength - oldLength);
        });
    });
    // Remove commas before submit
    document.getElementById('prices-form').addEventListener('submit', function(e) {
        document.querySelectorAll('.comma-number').forEach(function(input) {
            input.value = input.value.replace(/,/g, '');
        });
    });
    </script>
    {% endif %}

    {% if step == 'bundle' %}
    <form method="post">
        <h2>Create a Messaging Bundle?</h2>
        <p>Would you like to create a messaging bundle and lock in a fixed price for your monthly messaging volume?</p>
        <label>
            <input type="radio" name="bundle_choice" value="Yes" required> Yes
        </label>
        <label>
            <input type="radio" name="bundle_choice" value="No" required> No
        </label>
        <br><br>
        <input type="hidden" name="step" value="bundle">
        <input type="submit" value="Continue">
    </form>
    {% endif %}

    {% if step == 'results' %}
        <h2>Results</h2>
        
        <h3>Section 1: Pricing</h3>
        {% if bundle_details and bundle_details.lines %}
        <h4>Message Bundle</h4>
        <table>
            <tr>
                <th>Charge Type</th>
                <th>Volume Included</th>
                <th>Bundle Price (per message)</th>
                <th>Overage Price (per message)</th>
            </tr>
            {% for line in bundle_details.lines %}
            <tr>
                <td>{{ line.label or 'N/A' }}</td>
                <td>{{ '{:,.0f}'.format(line.volume or 0) if ((line.volume or 0) % 1) == 0 else '{:,.3f}'.format(line.volume or 0) }}</td>
                <td>{{ currency_symbol }}{{ '{:,.0f}'.format(line.price or 0) if ((line.price or 0) % 1) == 0 else '{:,.3f}'.format(line.price or 0) }}</td>
                <td>{{ currency_symbol }}{{ '{:,.0f}'.format(line.overage_price or 0) if ((line.overage_price or 0) % 1) == 0 else '{:,.3f}'.format(line.overage_price or 0) }}</td>
            </tr>
            {% endfor %}
            <tr>
                <td>Platform Fee</td>
                <td>
                    <ul style="margin:0; padding-left:18px;">
                        {% for comp in session.selected_components %}
                            <li>{{ comp }}</li>
                        {% endfor %}
                    </ul>
                </td>
                <td colspan="2" style="text-align:right;">{{ currency_symbol }}{{ '{:,.0f}'.format(chosen_platform_fee or 0) if ((chosen_platform_fee or 0) % 1) == 0 else '{:,.3f}'.format(chosen_platform_fee or 0) }}</td>
            </tr>
        </table>
        <p><b>Total Bundle Cost (messages only):</b> {{ currency_symbol }}{{ '{:,.0f}'.format(bundle_details.bundle_cost or 0) if ((bundle_details.bundle_cost or 0) % 1) == 0 else '{:,.3f}'.format(bundle_details.bundle_cost or 0) }}</p>
        <p><b>Total Bundle Price (Platform Fee + Bundle):</b> {{ currency_symbol }}{{ '{:,.0f}'.format(bundle_details.total_bundle_price or 0) if ((bundle_details.total_bundle_price or 0) % 1) == 0 else '{:,.3f}'.format(bundle_details.total_bundle_price or 0) }}</p>
        <p><b>Inclusion:</b> {{ bundle_details.inclusion_text or 'N/A' }}</p>
        {% endif %}
        <p><b>Expected Invoice Amount (Meta charges + Gupshup fee + Platform fee):</b> {{ currency_symbol }}{{ expected_invoice_amount }}</p>
        
        <h4>Inclusions</h4>
        <ul>
            {% for inc in final_inclusions %}
                <li>{{ inc }}</li>
            {% endfor %}
        </ul>
        
        <hr>
        
        <h3>Section 2: Internal - Not to be shared</h3>
        <h4>Margin and Cost Details</h4>
        <p><b>Chosen Platform Fee:</b> {{ currency_symbol }}{{ '{:,.0f}'.format(chosen_platform_fee or 0) if ((chosen_platform_fee or 0) % 1) == 0 else '{:,.3f}'.format(chosen_platform_fee or 0) }}</p>
        <p><b>Rate Card Platform Fee:</b> {{ currency_symbol }}{{ '{:,.0f}'.format(rate_card_platform_fee or 0) if ((rate_card_platform_fee or 0) % 1) == 0 else '{:,.3f}'.format(rate_card_platform_fee or 0) }}</p>
        <table>
            <tr>
                <th>Line Item</th>
                <th>Volume</th>
                <th>Chosen Price/message</th>
                <th>Rate Card Price/message</th>
                <th>Overage Price/message</th>
                <th>Revenue (Chosen) {{ currency_symbol }}/month</th>
                <th>Revenue (Rate Card) {{ currency_symbol }}/month</th>
            </tr>
            {% for item in results.line_items %}
            <tr>
                <td>{{ item.label }}</td>
                <td>{{ item.volume }}</td>
                <td>{{ item.chosen_price }}</td>
                <td>{{ item.suggested_price }}</td>
                <td>{{ item.overage_price }}</td>
                <td>{{ item.revenue }}</td>
                <td>{{ item.suggested_revenue }}</td>
            </tr>
            {% endfor %}
        </table>
        <br>
        <table>
            <tr><td colspan="3"><small>Note: Margin is calculated using the chosen platform fee (editable in the previous step).</small></td></tr>
            <tr><th>Total Revenue (Chosen) {{ currency_symbol }}/month</th><td colspan="2">{{ results.revenue }}</td></tr>
            <tr><th>Total Revenue (Rate Card) {{ currency_symbol }}/month</th><td colspan="2">{{ results.suggested_revenue }}</td></tr>
            <tr><th>Channel Cost</th><td colspan="2">{{ results.channel_cost }}</td></tr>
            <tr><th>AI Costs {{ currency_symbol }}/month</th><td colspan="2">{{ results.ai_costs }}</td></tr>
            <tr><th>Total Costs {{ currency_symbol }}/month</th><td colspan="2">{{ results.total_costs }}</td></tr>
            <tr><th>Margin (User Chosen)</th><td colspan="2">{{ results.margin }}</td></tr>
            <tr><th>Margin (Rate Card)</th><td colspan="2">{{ results.suggested_margin }}</td></tr>
        </table>
        
        <br>
        <form method="get">
            <input type="submit" value="Start Over">
        </form>
    {% endif %}

    {% if step != 'volumes' %}
    <form method="post" style="display:inline;">
        <input type="hidden" name="step" value="volumes">
        <input type="submit" value="Edit Volumes">
    </form>
    {% endif %}
    {% if step != 'prices' %}
    <form method="post" style="display:inline;">
        <input type="hidden" name="step" value="prices">
        <input type="submit" value="Edit Prices">
    </form>
    {% endif %}
</body>
</html>