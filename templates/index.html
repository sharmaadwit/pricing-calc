<!--
  index.html - Main template for the Pricing Calculator app
  Sections: How to Use, Volumes Form, Prices Form, Bundle Form, Results, Inclusions, Internal Margin Table
  Comments added for clarity for future developers.
-->
<!DOCTYPE html>
<html>
<head>
    <title>Pricing Calculator</title>
    <style>
        body { font-family: 'Segoe UI', 'Arial', 'sans-serif'; }
        h2, h3, h4 { font-weight: bold; margin-top: 1.5em; }
        h2 { font-size: 2em; }
        h3 { font-size: 1.5em; }
        h4 { font-size: 1.2em; }
        .section { margin-bottom: 2em; }
        hr { border: none; border-top: 1px solid #ccc; margin: 2em 0; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 1.5em; }
        table tr:nth-child(even) { background-color: #f9f9f9; }
        table tr:nth-child(odd) { background-color: #fff; }
        table th, table td { padding: 8px 12px; }
        th { background: #f0f0f0; }
        td, th { text-align: right; }
        th:first-child, td:first-child { text-align: left; }
        label { display: block; margin-top: 0.4em; margin-bottom: 0.1em; font-weight: 500; }
        input, select { margin-top: 0.1em; margin-bottom: 0.3em; }
        .key-number { font-weight: bold; font-size: 1.1em; }
        .flashes {
          list-style: none;
          padding: 0;
          margin: 1em 0;
        }
        .flashes li {
          background: #ffe0e0;
          color: #b30000;
          border: 1px solid #b30000;
          padding: 10px 16px;
          margin-bottom: 8px;
          font-weight: bold;
          border-radius: 4px;
        }
        .flashes li.error {
          background: #ffe0e0;
          color: #b30000;
          border: 1px solid #b30000;
        }
        .flashes li.success {
          background: #e0ffe0;
          color: #006600;
          border: 1px solid #006600;
        }
    </style>
    <script>
    // Global function for adding commas to numbers
    function addCommas(nStr) {
        nStr = nStr.replace(/,/g, '');
        if (nStr === '') return '';
        var parts = nStr.split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return parts.join('.');
    }
    </script>
</head>
<body>
    <!-- Flash messages for errors and notifications -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flashes">
          {% for category, message in messages %}
            <li class="{{ category }}">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}
    <h1>Pricing Calculator</h1>

    <!-- How to Use and User Flow Diagram -->
    {% if step == 'volumes' %}
    <div style="background: #f8fafd; border: 1.5px solid #dbe2ea; border-radius: 8px; padding: 18px 28px; margin-bottom: 24px;">
      <h3 style="margin-top:0;">How to Use</h3>
      <ul style="margin:0 0 0 18px; padding:0; font-size:1.08em;">
        <li>Enter your expected monthly message volumes and select platform options.</li>
        <li>You can enter 0 volumes in this step to go through credit bundle flow.</li>
        <li>Click 'Continue' to see the detailed pricing and inclusions.</li>
        <li>Review the results. The internal section is for your reference only.</li>
      </ul>
      <h4 style="margin-top:18px;">User Flow Diagram</h4>
      <div style="margin: 18px 0; text-align: center;">
        <!-- User Flow Diagram (Option 1: Linear with Branch for Committed Amount) -->
        <img src="{{ url_for('static', filename='user-flow.svg') }}" alt="User Flow Diagram" style="width:700px; height:250px; border:1.5px solid #dbe2ea; border-radius:8px; background:#fff; padding:8px;">
      </div>
      <div style="text-align: center; margin-top: 18px;">
        <!--
        <a href="{{ url_for('readme') }}" target="_blank" style="display: inline-block; padding: 10px 24px; background: #1976d2; color: #fff; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 1.08em; box-shadow: 0 2px 6px rgba(25,118,210,0.08);">Learn More</a>
        -->
      </div>
    </div>
    {% endif %}

    <!-- Volumes Form Section -->
    {% if step == 'volumes' %}
    <div style="display: flex; flex-direction: row; align-items: flex-start;">
      <div style="flex: 1; min-width: 0;">
    <form method="post" id="volumes-form">
        <input type="hidden" name="step" value="volumes">
            <label for="user_name">Enter your name:</label>
            <input type="text" name="user_name" id="user_name" value="{{ inputs.get('user_name', '') }}" required><br><br>
        <label>Country:</label>
        <select name="country" id="country-select" onchange="updateMinPlatformFee()">
                <option value="India" {% if inputs and inputs.country == 'India' %}selected{% endif %}>India</option>
                <option value="MENA" {% if inputs and inputs.country == 'MENA' %}selected{% endif %}>MENA</option>
                <option value="LATAM" {% if inputs and inputs.country == 'LATAM' %}selected{% endif %}>LATAM</option>
                <option value="Africa" {% if inputs and inputs.country == 'Africa' %}selected{% endif %}>Africa</option>
                <option value="Europe" {% if inputs and inputs.country == 'Europe' %}selected{% endif %}>Europe</option>
                <option value="Rest of the World" {% if inputs and inputs.country == 'Rest of the World' %}selected{% endif %}>Rest of the World</option>
        </select><br><br>
        <label>AI Message Volume (per month):</label>
            <input type="text" name="ai_volume" class="comma-number" value="{{ inputs.get('ai_volume', '') }}"><br><br>
        <label>Advanced Message Volume (per month):</label>
            <input type="text" name="advanced_volume" class="comma-number" value="{{ inputs.get('advanced_volume', '') }}"><br><br>
        <label>Basic Marketing Message Volume (per month):</label>
            <input type="text" name="basic_marketing_volume" class="comma-number" value="{{ inputs.get('basic_marketing_volume', '') }}"><br><br>
        <label>Basic Utility/Authentication Message Volume (per month):</label>
            <input type="text" name="basic_utility_volume" class="comma-number" value="{{ inputs.get('basic_utility_volume', '') }}"><br><br>
        <label>Minimum Platform Fee:</label>
        <input type="text" id="min_platform_fee" name="min_platform_fee" value="" readonly><br>
            <small>80 TPS, Journey Builder Lite, Campaign Manager, CTWA - (Meta/Tiktok), Agent Assist < 20 Agents, Personalize upto 1 Million profiles and external events not supported</small><br><br>
            <label>Personalize Load:</label>
            <select name="personalize_load">
                <option value="NA" {% if inputs and inputs.personalize_load == 'NA' %}selected{% endif %}>- Not Applicable</option>
                <option value="Standard" {% if inputs and inputs.personalize_load == 'Standard' %}selected{% endif %}>Standard - upto 5 million records, no external events</option>
                <option value="Advanced" {% if inputs and inputs.personalize_load == 'Advanced' %}selected{% endif %}>Advanced - 10 million records, external events supported</option>
            </select><br>
            <small>If the client requires large number of profiles and support for external events, select the appropriate tier.</small><br><br>
        <label>BFSI Tier:</label>
        <select name="bfsi_tier">
                <option value="NA" {% if inputs and inputs.bfsi_tier == 'NA' %}selected{% endif %}>- Not Applicable</option>
                <option value="Tier 1" {% if inputs and inputs.bfsi_tier == 'Tier 1' %}selected{% endif %}>Tier 1</option>
                <option value="Tier 2" {% if inputs and inputs.bfsi_tier == 'Tier 2' %}selected{% endif %}>Tier 2</option>
                <option value="Tier 3" {% if inputs and inputs.bfsi_tier == 'Tier 3' %}selected{% endif %}>Tier 3</option>
            </select><br>
            <small>Each tier comes with specific controls of privacy and security requirements. The exact inclusions of each tier will be displayed on the final pricing page.</small><br><br>
        <label>AI Module (Yes/No):</label>
        <select name="ai_module">
                <option value="NA" {% if inputs and inputs.ai_module == 'NA' %}selected{% endif %}>- Not Applicable</option>
                <option value="Yes" {% if inputs and inputs.ai_module == 'Yes' %}selected{% endif %}>Yes</option>
                <option value="No" {% if inputs and inputs.ai_module == 'No' %}selected{% endif %}>No</option>
            </select><br>
            <small>Access to Workspace Configuration and data retraining screens</small><br><br>
        <label>Smart CPaaS:</label>
        <select name="smart_cpaas">
                <option value="No" {% if inputs and inputs.smart_cpaas == 'No' %}selected{% endif %}>No</option>
                <option value="Yes" {% if inputs and inputs.smart_cpaas == 'Yes' %}selected{% endif %}>Yes</option>
            </select><br>
            <small>Auto failover between channels</small><br><br>
            <label>Increased TPS:</label>
            <select name="increased_tps">
                <option value="NA" {% if inputs and inputs.increased_tps == 'NA' %}selected{% endif %}>NA</option>
                <option value="250" {% if inputs and inputs.increased_tps == '250' %}selected{% endif %}>250 (upto 250 Messages per Second)</option>
                <option value="1000" {% if inputs and inputs.increased_tps == '1000' %}selected{% endif %}>1000 (upto 1000 Messages per Second)</option>
            </select><br>
            <small>Required to support high volume campaigns</small><br><br>
            <label>Number of Human Agents (Agent Assist):</label>
            <select name="human_agents">
                <option value="NA" {% if inputs and inputs.human_agents == 'NA' %}selected{% endif %}><20 already part of standard platform fee</option>
                <option value="20+" {% if inputs and inputs.human_agents == '20+' %}selected{% endif %}>20+</option>
                <option value="50+" {% if inputs and inputs.human_agents == '50+' %}selected{% endif %}>50+</option>
                <option value="100+" {% if inputs and inputs.human_agents == '100+' %}selected{% endif %}>100+</option>
        </select><br><br>
        <input type="submit" value="Next: Rate Card">
    </form>
      </div>
    </div>
    <script>
    function updateMinPlatformFee() {
        var country = document.getElementById('country-select').value;
        var minFee = '';
        if (country === 'India') minFee = 'INR 100000';
        else if (country === 'Africa' || country === 'Rest of the World') minFee = 'USD 500';
        else minFee = 'USD 1000';
        document.getElementById('min_platform_fee').value = minFee;
    }
    window.onload = updateMinPlatformFee;
    
    // Format input with commas as user types
    document.querySelectorAll('.comma-number').forEach(function(input) {
        input.addEventListener('input', function(e) {
            var cursor = input.selectionStart;
            var oldLength = input.value.length;
            input.value = addCommas(input.value);
            var newLength = input.value.length;
            input.selectionEnd = cursor + (newLength - oldLength);
        });
    });
    // Remove commas before submit
    document.getElementById('volumes-form').addEventListener('submit', function(e) {
        document.querySelectorAll('.comma-number').forEach(function(input) {
            input.value = input.value.replace(/,/g, '');
        });
    });
    </script>
    {% endif %}

    <!-- Prices Form Section -->
    {% if step == 'prices' %}
    <form method="post" id="prices-form">
        <input type="hidden" name="step" value="prices">
        <h2>Rate Card Pricing</h2>
        <p>Review and adjust the suggested prices if needed. These prices will be used to calculate your final pricing.</p>
        <label>Platform Fee (editable):</label>
        {{ currency_symbol }}<input type="text" name="platform_fee" class="comma-number" value="{{ platform_fee }}" required><br>
        <small>This is the calculated platform fee based on your selections. You can edit it if needed.</small><br><br>
        <label>AI Message Rate Card:</label>
        {{ currency_symbol }}<input type="text" name="ai_price" class="comma-number" value="{{ suggested.ai_price }}" required><br><br>
        <label>Advanced Message Rate Card:</label>
        {{ currency_symbol }}<input type="text" name="advanced_price" class="comma-number" value="{{ suggested.advanced_price }}" required><br><br>
        <label>Basic Marketing Message Rate Card:</label>
        {{ currency_symbol }}<input type="text" name="basic_marketing_price" class="comma-number" value="{{ suggested.basic_marketing_price }}" required><br><br>
        <label>Basic Utility/Authentication Message Rate Card:</label>
        {{ currency_symbol }}<input type="text" name="basic_utility_price" class="comma-number" value="{{ suggested.basic_utility_price }}" required><br><br>
        <input type="submit" value="Calculate Results">
    </form>
    <form method="get">
        <input type="submit" value="Back to Volumes">
    </form>
    <script>
    // Format input with commas as user types
    document.querySelectorAll('.comma-number').forEach(function(input) {
        input.addEventListener('input', function(e) {
            var cursor = input.selectionStart;
            var oldLength = input.value.length;
            input.value = addCommas(input.value);
            var newLength = input.value.length;
            input.selectionEnd = cursor + (newLength - oldLength);
        });
    });
    // Remove commas before submit
    document.getElementById('prices-form').addEventListener('submit', function(e) {
        document.querySelectorAll('.comma-number').forEach(function(input) {
            input.value = input.value.replace(/,/g, '');
        });
    });
    </script>
    {% endif %}

    <!-- Bundle Form Section (for committed amount path) -->
    {% if step == 'bundle' %}
    {% set all_volumes_zero = (inputs.get('ai_volume', 0)|float == 0 and inputs.get('advanced_volume', 0)|float == 0 and inputs.get('basic_marketing_volume', 0)|float == 0 and inputs.get('basic_utility_volume', 0)|float == 0) %}
    {% if all_volumes_zero %}
    <form method="post">
        <h2>Enter Committed Monthly Amount</h2>
        <label>Committed Amount ({{ currency_symbol }}):</label>
        <input type="text" name="committed_amount" class="comma-number" required><br><br>
        <input type="hidden" name="step" value="bundle">
        <input type="submit" value="Continue">
    </form>
    {% endif %}
    {% endif %}

    <!-- Results Section: Pricing Table, Inclusions, Invoice Amount, Margin Table -->
    {% if step == 'results' %}
        <div style="max-width: 1100px; margin: 0 auto;">
          <h2 style="margin-top:0;">Section 1: Pricing</h2>
          <!-- Pricing Table -->
          <div style="margin-bottom: 24px;">
            <table style="border-collapse: collapse; width: 100%; font-size: 1.05em;">
              <thead>
                <tr style="background: #f0f4f8;">
                  <th style="text-align:left;">Line Item</th>
                  <th style="text-align:right;">Volume</th>
                  <th style="text-align:right;">Chosen Price/message</th>
                  <th style="text-align:right;">Overage Price/message</th>
                  <th style="text-align:right;">Fixed Price</th>
                </tr>
              </thead>
              <tbody>
              {% for row in pricing_table %}
                <tr>
                      <td>{{ row.line_item or row.label }}</td>
                      <td class="right">{{ row.volume }}</td>
                      <td class="right">{{ row.chosen_price }}</td>
                      <td class="right">{{ row.overage_price }}</td>
                      <td class="right">
                          {% if row.line_item == 'Platform Fee (Chosen)' %}
                              {{ currency_symbol }}{{ row.revenue }}
                              {% if user_selections and user_selections|length > 0 %}<br>
                                  <span style="font-size:0.92em; color:#888;">
                                      {% for label, value in user_selections %}
                                          {{ label }}: {{ value }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                                  </span>
                              {% endif %}
                          {% elif row.line_item == 'Committed Amount' %}
                              {{ currency_symbol }}{{ row.revenue }}
                          {% else %}
                              &nbsp;
                          {% endif %}
                    </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
          <!-- Inclusions Section -->
          <div style="margin-bottom: 18px;">
            <h3 style="margin-bottom: 8px;">Inclusions</h3>
            <ul style="margin:0 0 0 18px; padding:0; font-size:1.08em;">
              {% for inc in final_inclusions %}
                <li style="margin-bottom:2px;">{{ inc }}</li>
                        {% endfor %}
                        </ul>
          </div>
          <!-- Expected Invoice Amount block -->
          <div style="background: #f5f7fa; border: 1.5px solid #dbe2ea; border-radius: 8px; padding: 18px 28px; margin-bottom: 24px; display: flex; align-items: center;">
            <div style="flex:1;">
              <h2 style="margin:0; font-size: 1.3em;">Expected Invoice Amount = Meta Cost * committed volumes + Platform Cost</h2>
              <div style="font-size: 2em; font-weight: bold; color: #1a2a3a; margin-top: 2px;">{{ currency_symbol }}{{ '{:,.0f}'.format(expected_invoice_amount or 0) if ((expected_invoice_amount or 0) % 1) == 0 else '{:,.2f}'.format(expected_invoice_amount or 0) }}</div>
            </div>
            {% if bundle_details and bundle_details.committed_amount is defined %}
            <div style="background: #eaf6ff; border-left: 4px solid #2196f3; padding: 12px 18px; border-radius: 6px; margin-left: 32px; font-size: 1.08em;">
              <b>Committed Deal:</b> Bundle Commitment + Platform Fee<br>
              <span style="color:#333;">Your committed amount will be drawn down as you use the platform, based on the agreed rates for each message type. Overage prices apply if you exceed the commitment.</span>
            </div>
                {% endif %}
          </div>
        </div>
        <!-- Internal Section: Margin Table for Internal Use Only -->
        <div style="max-width: 1100px; margin: 0 auto;">
          <div style="background: #f8f8fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 18px 24px; margin-top: 32px;">
            <h2 style="margin-top:0; color:#444;">Section 2: Internal - Not to be shared</h2>
            <table style="border-collapse: collapse; width: 100%; font-size: 1.05em;">
              <thead>
                <tr style="background: #f0f4f8;">
                  <th style="text-align:left;">Item</th>
                  <th style="text-align:right;">Chosen Price</th>
                  <th style="text-align:right;">Rate Card Price</th>
                  <th style="text-align:right;">Discount (%)</th>
                </tr>
              </thead>
              <tbody>
                {% for row in margin_table %}
                <tr>
                    <td>{{ row.line_item }}</td>
                    <td class="right">{{ row.chosen_price }}</td>
                    <td class="right">{{ row.rate_card_price }}</td>
                    <td class="right">{{ row.discount_percent }}</td>
                </tr>
            {% endfor %}
              </tbody>
        </table>
            <div style="font-size:1.08em; margin-top:12px;">
              <b>Total Chosen Revenue:</b> {{ currency_symbol }}{{ results.revenue }}<br>
              <b>Total Rate Card Revenue:</b> {{ currency_symbol }}{{ results.suggested_revenue }}
            </div>
            <div style="font-size:1.08em; margin-top:12px;">
              <b>Note:</b> This section is for internal use only and should not be shared with the customer.
            </div>
            {% if results.margin and (inputs.get('ai_volume', 0)|float > 0 or inputs.get('advanced_volume', 0)|float > 0 or inputs.get('basic_marketing_volume', 0)|float > 0 or inputs.get('basic_utility_volume', 0)|float > 0) %}
            <div style="font-size:1.15em; margin-top:18px; color:#1a2a3a;">
              <b>Total Margin (as per formula above):</b> {{ results.margin }}
            </div>
            {% endif %}
          </div>
        </div>
        <form method="get" action="/" style="margin-top: 32px; text-align: center;">
            <input type="submit" value="Start Over">
        </form>
    {% endif %}

    <!-- Disabled Edit Buttons for Future Features -->
    {% if step != 'volumes' %}
    <form method="post" style="display:inline;" onsubmit="event.preventDefault(); alert('Coming soon'); return false;">
        <input type="hidden" name="step" value="volumes">
        <input type="submit" value="Edit Volumes" disabled style="opacity:0.5; cursor:not-allowed;">
    </form>
    {% endif %}
    {% if step != 'prices' %}
    <form method="post" style="display:inline;" onsubmit="event.preventDefault(); alert('Coming soon'); return false;">
        <input type="hidden" name="step" value="prices">
        <input type="submit" value="Edit Prices" disabled style="opacity:0.5; cursor:not-allowed;">
        </form>
    {% endif %}
</body>
</html>