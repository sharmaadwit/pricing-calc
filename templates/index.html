<!DOCTYPE html>
<html>
<head>
    <title>Pricing Calculator</title>
    <style>
        table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 6px; }
        th { background: #f0f0f0; }
    </style>
    <script>
    // Global function for adding commas to numbers
    function addCommas(nStr) {
        nStr = nStr.replace(/,/g, '');
        if (nStr === '') return '';
        var parts = nStr.split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return parts.join('.');
    }
    </script>
</head>
<body>
    <h1>Pricing Calculator</h1>

    {% if step == 'volumes' %}
    <form method="post" id="volumes-form">
        <input type="hidden" name="step" value="volumes">
        <label>Country:</label>
        <select name="country" id="country-select" onchange="updateMinPlatformFee()">
            <option value="India" {% if inputs and inputs.country == 'India' %}selected{% endif %}>India</option>
            <option value="MENA" {% if inputs and inputs.country == 'MENA' %}selected{% endif %}>MENA</option>
            <option value="LATAM" {% if inputs and inputs.country == 'LATAM' %}selected{% endif %}>LATAM</option>
            <option value="Africa" {% if inputs and inputs.country == 'Africa' %}selected{% endif %}>Africa</option>
            <option value="Europe" {% if inputs and inputs.country == 'Europe' %}selected{% endif %}>Europe</option>
            <option value="Rest of the World" {% if inputs and inputs.country == 'Rest of the World' %}selected{% endif %}>Rest of the World</option>
        </select><br><br>
        <label>AI Message Volume (per month):</label>
        <input type="text" name="ai_volume" class="comma-number" required value="{{ inputs.ai_volume if inputs and inputs.ai_volume is defined else '' }}"><br><br>
        <label>Advanced Message Volume (per month):</label>
        <input type="text" name="advanced_volume" class="comma-number" required value="{{ inputs.advanced_volume if inputs and inputs.advanced_volume is defined else '' }}"><br><br>
        <label>Basic Marketing Message Volume (per month):</label>
        <input type="text" name="basic_marketing_volume" class="comma-number" required value="{{ inputs.basic_marketing_volume if inputs and inputs.basic_marketing_volume is defined else '' }}"><br><br>
        <label>Basic Utility/Authentication Message Volume (per month):</label>
        <input type="text" name="basic_utility_volume" class="comma-number" required value="{{ inputs.basic_utility_volume if inputs and inputs.basic_utility_volume is defined else '' }}"><br><br>
        <label>Minimum Platform Fee:</label>
        <input type="text" id="min_platform_fee" name="min_platform_fee" value="" readonly><br>
        <small>This is the minimum platform fee for the selected country. It cannot be edited.</small><br><br>
        <label>BFSI Tier:</label>
        <select name="bfsi_tier">
            <option value="NA" {% if inputs and inputs.bfsi_tier == 'NA' %}selected{% endif %}>NA</option>
            <option value="Tier 1" {% if inputs and inputs.bfsi_tier == 'Tier 1' %}selected{% endif %}>Tier 1</option>
            <option value="Tier 2" {% if inputs and inputs.bfsi_tier == 'Tier 2' %}selected{% endif %}>Tier 2</option>
            <option value="Tier 3" {% if inputs and inputs.bfsi_tier == 'Tier 3' %}selected{% endif %}>Tier 3</option>
        </select><br><br>
        <label>Personalize Load:</label>
        <select name="personalize_load">
            <option value="NA" {% if inputs and inputs.personalize_load == 'NA' %}selected{% endif %}>NA</option>
            <option value="Standard" {% if inputs and inputs.personalize_load == 'Standard' %}selected{% endif %}>Standard</option>
            <option value="Advanced" {% if inputs and inputs.personalize_load == 'Advanced' %}selected{% endif %}>Advanced</option>
        </select><br><br>
        <label>Number of Human Agents (Agent Assist):</label>
        <select name="human_agents">
            <option value="NA" {% if inputs and inputs.human_agents == 'NA' %}selected{% endif %}>NA</option>
            <option value="20+" {% if inputs and inputs.human_agents == '20+' %}selected{% endif %}>20+</option>
            <option value="50+" {% if inputs and inputs.human_agents == '50+' %}selected{% endif %}>50+</option>
            <option value="100+" {% if inputs and inputs.human_agents == '100+' %}selected{% endif %}>100+</option>
        </select><br><br>
        <label>AI Module (Yes/No):</label>
        <select name="ai_module">
            <option value="NA" {% if inputs and inputs.ai_module == 'NA' %}selected{% endif %}>NA</option>
            <option value="Yes" {% if inputs and inputs.ai_module == 'Yes' %}selected{% endif %}>Yes</option>
            <option value="No" {% if inputs and inputs.ai_module == 'No' %}selected{% endif %}>No</option>
        </select><br><br>
        <label>Smart CPaaS:</label>
        <select name="smart_cpaas">
            <option value="No" {% if inputs and inputs.smart_cpaas == 'No' %}selected{% endif %}>No</option>
            <option value="Yes" {% if inputs and inputs.smart_cpaas == 'Yes' %}selected{% endif %}>Yes</option>
        </select><br><br>
        <label>Increased TPS:</label>
        <select name="increased_tps">
            <option value="NA" {% if inputs and inputs.increased_tps == 'NA' %}selected{% endif %}>NA</option>
            <option value="250" {% if inputs and inputs.increased_tps == '250' %}selected{% endif %}>250 (upto 250 Messages per Second)</option>
            <option value="1000" {% if inputs and inputs.increased_tps == '1000' %}selected{% endif %}>1000 (upto 1000 Messages per Second)</option>
        </select><br><br>
        <input type="submit" value="Next: Rate Card">
    </form>
    <script>
    function updateMinPlatformFee() {
        var country = document.getElementById('country-select').value;
        var minFee = '';
        if (country === 'India') minFee = 'INR 100000';
        else if (country === 'Africa' || country === 'Rest of the World') minFee = 'USD 500';
        else minFee = 'USD 1000';
        document.getElementById('min_platform_fee').value = minFee;
    }
    window.onload = updateMinPlatformFee;
    
    // Format input with commas as user types
    document.querySelectorAll('.comma-number').forEach(function(input) {
        input.addEventListener('input', function(e) {
            var cursor = input.selectionStart;
            var oldLength = input.value.length;
            input.value = addCommas(input.value);
            var newLength = input.value.length;
            input.selectionEnd = cursor + (newLength - oldLength);
        });
    });
    // Remove commas before submit
    document.getElementById('volumes-form').addEventListener('submit', function(e) {
        document.querySelectorAll('.comma-number').forEach(function(input) {
            input.value = input.value.replace(/,/g, '');
        });
    });
    </script>
    {% endif %}

    {% if step == 'prices' %}
    <form method="post" id="prices-form">
        <input type="hidden" name="step" value="prices">
        <h2>Rate Card Gupshup Fee on top of channel costs(edit if needed)</h2>
        <label>Platform Fee (editable):</label>
        {{ currency_symbol }}<input type="text" name="platform_fee" class="comma-number" value="{{ platform_fee }}" required><br>
        <small>This is the calculated platform fee based on your selections. You can edit it if needed.</small><br><br>
        <label>AI Message Rate Card:</label>
        {{ currency_symbol }}<input type="text" name="ai_price" class="comma-number" value="{{ suggested.ai_price }}" required><br><br>
        <label>Advanced Message Rate Card:</label>
        {{ currency_symbol }}<input type="text" name="advanced_price" class="comma-number" value="{{ suggested.advanced_price }}" required><br><br>
        <label>Basic Marketing Message Rate Card:</label>
        {{ currency_symbol }}<input type="text" name="basic_marketing_price" class="comma-number" value="{{ suggested.basic_marketing_price }}" required><br><br>
        <label>Basic Utility/Authentication Message Rate Card:</label>
        {{ currency_symbol }}<input type="text" name="basic_utility_price" class="comma-number" value="{{ suggested.basic_utility_price }}" required><br><br>
        <input type="submit" value="Calculate Results">
    </form>
    <form method="get">
        <input type="submit" value="Back to Volumes">
    </form>
    <script>
    // Format input with commas as user types
    document.querySelectorAll('.comma-number').forEach(function(input) {
        input.addEventListener('input', function(e) {
            var cursor = input.selectionStart;
            var oldLength = input.value.length;
            input.value = addCommas(input.value);
            var newLength = input.value.length;
            input.selectionEnd = cursor + (newLength - oldLength);
        });
    });
    // Remove commas before submit
    document.getElementById('prices-form').addEventListener('submit', function(e) {
        document.querySelectorAll('.comma-number').forEach(function(input) {
            input.value = input.value.replace(/,/g, '');
        });
    });
    </script>
    {% endif %}

    {% if step == 'bundle' %}
    <form method="post">
        <h2>Create a Messaging Bundle?</h2>
        <p>Would you like to create a messaging bundle and lock in a fixed price for your monthly messaging volume?</p>
        <label>
            <input type="radio" name="bundle_choice" value="Yes" required> Yes
        </label>
        <label>
            <input type="radio" name="bundle_choice" value="No" required> No
        </label>
        <br><br>
        <input type="hidden" name="step" value="bundle">
        <input type="submit" value="Continue">
    </form>
    {% endif %}

    {% if step == 'results' %}
        <h2>Results</h2>
        {% if bundle_details %}
        <h3>Messaging Bundle Summary</h3>
        <table>
            <tr><th>Number of Messages</th><td>{{ bundle_details.total_volume }}</td></tr>
            <tr><th>Bundle Price (per message)</th><td>{{ currency_symbol }}{{ bundle_details.avg_price }}</td></tr>
            <tr><th>Total Bundle Cost</th><td>{{ currency_symbol }}{{ bundle_details.bundle_cost }}</td></tr>
            <tr><th>Overage Price (per message)</th><td>{{ currency_symbol }}{{ bundle_details.overage_price }}</td></tr>
            <tr><th>Inclusion</th><td>{{ bundle_details.inclusion_text }}</td></tr>
        </table>
        <br>
        {% endif %}
        <table>
            <tr>
                <th>Line Item</th>
                <th>Volume</th>
                <th>Chosen Price/message</th>
                <th>Rate Card Price/message</th>
                <th>Overage Price/message</th>
                <th>Revenue (Chosen) {{ currency_symbol }}/month</th>
                <th>Revenue (Rate Card) {{ currency_symbol }}/month</th>
            </tr>
            {% for item in results.line_items %}
            <tr>
                <td>{{ item.label }}</td>
                <td>{{ item.volume }}</td>
                <td>{{ item.chosen_price }}</td>
                <td>{{ item.suggested_price }}</td>
                <td>{{ item.overage_price }}</td>
                <td>{{ item.revenue }}</td>
                <td>{{ item.suggested_revenue }}</td>
            </tr>
            {% endfor %}
        </table>
        <br>
        <table>
            <tr>
                <th>Platform Fee Section</th>
                <th>Value</th>
                <th>Inclusions</th>
            </tr>
            <tr>
                <td>Platform Fee Used for Margin Calculation</td>
                <td>{{ chosen_platform_fee }}</td>
                <td>
                    <ul>
                    {% for inc in inclusions['Platform Fee Used for Margin Calculation'] %}
                        <li>{{ inc }}</li>
                    {% endfor %}
                    </ul>
                </td>
            </tr>
            <tr>
                <td>Rate Card Platform Fee</td>
                <td>{{ rate_card_platform_fee }}</td>
                <td></td>
            </tr>
            {% for label, value in user_selections %}
                {% if label == 'BFSI Tier' and value in ['Tier 1', 'Tier 2', 'Tier 3'] %}
                <tr>
                    <td>BFSI {{ value }}</td>
                    <td>Included</td>
                    <td>
                        <ul>
                        {% for inc in inclusions['BFSI Tier ' ~ value.split(' ')[-1]] %}
                            <li>{{ inc }}</li>
                        {% endfor %}
                        </ul>
                    </td>
                </tr>
                {% endif %}
                {% if label == 'Personalize Load' and value in ['Standard', 'Advanced'] %}
                <tr>
                    <td>Personalize Load {{ value }}</td>
                    <td>Included</td>
                    <td>
                        <ul>
                        {% for inc in inclusions['Personalize Load ' ~ value] %}
                            <li>{{ inc }}</li>
                        {% endfor %}
                        </ul>
                    </td>
                </tr>
                {% endif %}
                {% if label == 'AI Module' and value == 'Yes' %}
                <tr>
                    <td>AI Module</td>
                    <td>Included</td>
                    <td>
                        <ul>
                        {% for inc in inclusions['AI Module Yes'] %}
                            <li>{{ inc }}</li>
                        {% endfor %}
                        </ul>
                    </td>
                </tr>
                {% endif %}
                {% if label == 'Human Agents' and value in ['20+', '50+', '100+'] %}
                <tr>
                    <td>Human Agents {{ value }}</td>
                    <td>Included</td>
                    <td>
                        <ul>
                        {% for inc in inclusions['Human Agents ' ~ value] %}
                            <li>{{ inc }}</li>
                        {% endfor %}
                        </ul>
                    </td>
                </tr>
                {% endif %}
                {% if label == 'Smart CPaaS' and value == 'Yes' %}
                <tr>
                    <td>Smart CPaaS</td>
                    <td>Included</td>
                    <td>
                        <ul>
                        {% for inc in inclusions['Smart CPaaS Yes'] %}
                            <li>{{ inc }}</li>
                        {% endfor %}
                        </ul>
                    </td>
                </tr>
                {% endif %}
                {% if label == 'Increased TPS' and value in ['250', '1000'] %}
                <tr>
                    <td>Increased TPS {{ value }}</td>
                    <td>Included</td>
                    <td>
                        <ul>
                        {% for inc in inclusions['Increased TPS ' ~ value] %}
                            <li>{{ inc }}</li>
                        {% endfor %}
                        </ul>
                    </td>
                </tr>
                {% endif %}
            {% endfor %}
        </table>
        <br>
        <table>
            <tr><td colspan="3"><small>Note: Margin is calculated using the chosen platform fee (editable in the previous step).</small></td></tr>
            <tr><th>Total Revenue (Chosen) {{ currency_symbol }}/month</th><td colspan="2">{{ results.revenue }}</td></tr>
            <tr><th>Total Revenue (Rate Card) {{ currency_symbol }}/month</th><td colspan="2">{{ results.suggested_revenue }}</td></tr>
            <tr><th>Channel Cost</th><td colspan="2">{{ results.channel_cost }}</td></tr>
            <tr><th>AI Costs {{ currency_symbol }}/month</th><td colspan="2">{{ results.ai_costs }}</td></tr>
            <tr><th>Total Costs {{ currency_symbol }}/month</th><td colspan="2">{{ results.total_costs }}</td></tr>
            <tr><th>Margin (User Chosen)</th><td colspan="2">{{ results.margin }}</td></tr>
            <tr><th>Margin (Rate Card)</th><td colspan="2">{{ results.suggested_margin }}</td></tr>
        </table>
        <br>
        <form method="get">
            <input type="submit" value="Start Over">
        </form>
    {% endif %}

    {% if step != 'volumes' %}
    <form method="post" style="display:inline;">
        <input type="hidden" name="step" value="volumes">
        <input type="submit" value="Edit Volumes">
    </form>
    {% endif %}
    {% if step != 'prices' %}
    <form method="post" style="display:inline;">
        <input type="hidden" name="step" value="prices">
        <input type="submit" value="Edit Prices">
    </form>
    {% endif %}
</body>
</html>