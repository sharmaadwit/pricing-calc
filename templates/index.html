<!DOCTYPE html>
<html>
<head>
    <title>Pricing Calculator</title>
    <style>
        body { font-family: 'Segoe UI', 'Arial', 'sans-serif'; }
        h2, h3, h4 { font-weight: bold; margin-top: 1.5em; }
        h2 { font-size: 2em; }
        h3 { font-size: 1.5em; }
        h4 { font-size: 1.2em; }
        .section { margin-bottom: 2em; }
        hr { border: none; border-top: 1px solid #ccc; margin: 2em 0; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 1.5em; }
        table tr:nth-child(even) { background-color: #f9f9f9; }
        table tr:nth-child(odd) { background-color: #fff; }
        table th, table td { padding: 8px 12px; }
        th { background: #f0f0f0; }
        td, th { text-align: right; }
        th:first-child, td:first-child { text-align: left; }
        label { display: block; margin-top: 0.4em; margin-bottom: 0.1em; font-weight: 500; }
        input, select { margin-top: 0.1em; margin-bottom: 0.3em; }
        .key-number { font-weight: bold; font-size: 1.1em; }
        .flashes {
          list-style: none;
          padding: 0;
          margin: 1em 0;
        }
        .flashes li {
          background: #ffe0e0;
          color: #b30000;
          border: 1px solid #b30000;
          padding: 10px 16px;
          margin-bottom: 8px;
          font-weight: bold;
          border-radius: 4px;
        }
        .flashes li.error {
          background: #ffe0e0;
          color: #b30000;
          border: 1px solid #b30000;
        }
        .flashes li.success {
          background: #e0ffe0;
          color: #006600;
          border: 1px solid #006600;
        }
    </style>
    <script>
    // Global function for adding commas to numbers
    function addCommas(nStr) {
        nStr = nStr.replace(/,/g, '');
        if (nStr === '') return '';
        var parts = nStr.split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return parts.join('.');
    }
    </script>
</head>
<body>
    <!-- DEBUG: Template loaded -->
    <!-- DEBUG: Step value: {{ step }} -->
    <!-- DEBUG: Step type: {{ step.__class__.__name__ if step else 'None' }} -->
    
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flashes">
          {% for category, message in messages %}
            <li class="{{ category }}">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}
    <h1>Pricing Calculator</h1>

    {% if step == 'volumes' %}
    <!-- DEBUG: In volumes section -->
    <!-- How to Use Guide -->
    <div style="background: #f8fafd; border: 1.5px solid #dbe2ea; border-radius: 8px; padding: 18px 28px; margin-bottom: 24px;">
      <h3 style="margin-top:0;">How to Use</h3>
      <ul style="margin:0 0 0 18px; padding:0; font-size:1.08em;">
        <li>Enter your expected monthly message volumes and select platform options.</li>
        <li>If you do not enter any volumes, you will be asked to enter a committed monthly amount.</li>
        <li>Click 'Continue' to see the detailed pricing and inclusions.</li>
        <li>Review the results. The internal section is for your reference only.</li>
      </ul>
      <h4 style="margin-top:18px;">User Flow Diagram</h4>
      <div style="margin: 18px 0; text-align: center;">
        <!-- Horizontally aligned SVG user flow diagram -->
        <svg width="900" height="160" viewBox="0 0 900 160" xmlns="http://www.w3.org/2000/svg">
          <g>
            <!-- Home Page -->
            <rect x="30" y="60" width="180" height="40" rx="8" fill="#eaf6ff" stroke="#2196f3" stroke-width="2"/>
            <text x="120" y="85" text-anchor="middle" font-size="16" fill="#1a2a3a">User lands on Home Page</text>
            <!-- Volumes & Prices -->
            <rect x="230" y="60" width="180" height="40" rx="8" fill="#eaf6ff" stroke="#2196f3" stroke-width="2"/>
            <text x="320" y="85" text-anchor="middle" font-size="16" fill="#1a2a3a">Enter Volumes & Prices</text>
            <!-- Committed Amount -->
            <rect x="430" y="10" width="180" height="40" rx="8" fill="#fffbe6" stroke="#ffc107" stroke-width="2"/>
            <text x="520" y="35" text-anchor="middle" font-size="16" fill="#7a5a00">Enter Committed Amount</text>
            <!-- Bundle always created -->
            <rect x="430" y="110" width="180" height="40" rx="8" fill="#eaf6ff" stroke="#2196f3" stroke-width="2"/>
            <text x="520" y="135" text-anchor="middle" font-size="16" fill="#1a2a3a">Bundle is always created</text>
            <!-- Results Page -->
            <rect x="650" y="60" width="180" height="40" rx="8" fill="#eaf6ff" stroke="#2196f3" stroke-width="2"/>
            <text x="740" y="85" text-anchor="middle" font-size="16" fill="#1a2a3a">Results Page</text>
            <!-- Start Over -->
            <rect x="850" y="60" width="40" height="40" rx="8" fill="#eaf6ff" stroke="#2196f3" stroke-width="2"/>
            <text x="870" y="85" text-anchor="middle" font-size="14" fill="#1a2a3a">â†º</text>
            <!-- Arrows -->
            <line x1="210" y1="80" x2="230" y2="80" stroke="#2196f3" stroke-width="2" marker-end="url(#arrow)"/>
            <line x1="410" y1="80" x2="430" y2="30" stroke="#2196f3" stroke-width="2" marker-end="url(#arrow)"/>
            <line x1="410" y1="80" x2="430" y2="130" stroke="#2196f3" stroke-width="2" marker-end="url(#arrow)"/>
            <line x1="610" y1="30" x2="650" y2="80" stroke="#2196f3" stroke-width="2" marker-end="url(#arrow)"/>
            <line x1="610" y1="130" x2="650" y2="80" stroke="#2196f3" stroke-width="2" marker-end="url(#arrow)"/>
            <line x1="830" y1="80" x2="850" y2="80" stroke="#2196f3" stroke-width="2" marker-end="url(#arrow)"/>
          </g>
          <defs>
            <marker id="arrow" markerWidth="10" markerHeight="10" refX="10" refY="5" orient="auto" markerUnits="strokeWidth">
              <path d="M0,0 L10,5 L0,10 L2,5 z" fill="#2196f3" />
            </marker>
          </defs>
        </svg>
      </div>
    </div>
    {% endif %}

    {% if step == 'volumes' %}
    <!-- DEBUG: Rendering volumes form -->
    <div style="display: flex; flex-direction: row; align-items: flex-start;">
      <div style="flex: 1; min-width: 0;">
        <form method="post" id="volumes-form">
            <input type="hidden" name="step" value="volumes">
            <label>Country:</label>
            <select name="country" id="country-select" onchange="updateMinPlatformFee()">
                <option value="India" {% if inputs and inputs.country == 'India' %}selected{% endif %}>India</option>
                <option value="MENA" {% if inputs and inputs.country == 'MENA' %}selected{% endif %}>MENA</option>
                <option value="LATAM" {% if inputs and inputs.country == 'LATAM' %}selected{% endif %}>LATAM</option>
                <option value="Africa" {% if inputs and inputs.country == 'Africa' %}selected{% endif %}>Africa</option>
                <option value="Europe" {% if inputs and inputs.country == 'Europe' %}selected{% endif %}>Europe</option>
                <option value="Rest of the World" {% if inputs and inputs.country == 'Rest of the World' %}selected{% endif %}>Rest of the World</option>
            </select><br><br>
            <label>AI Message Volume (per month):</label>
            <input type="text" name="ai_volume" class="comma-number" value="{{ inputs.ai_volume if inputs and inputs.ai_volume is defined else '' }}"><br><br>
            <label>Advanced Message Volume (per month):</label>
            <input type="text" name="advanced_volume" class="comma-number" value="{{ inputs.advanced_volume if inputs and inputs.advanced_volume is defined else '' }}"><br><br>
            <label>Basic Marketing Message Volume (per month):</label>
            <input type="text" name="basic_marketing_volume" class="comma-number" value="{{ inputs.basic_marketing_volume if inputs and inputs.basic_marketing_volume is defined else '' }}"><br><br>
            <label>Basic Utility/Authentication Message Volume (per month):</label>
            <input type="text" name="basic_utility_volume" class="comma-number" value="{{ inputs.basic_utility_volume if inputs and inputs.basic_utility_volume is defined else '' }}"><br><br>
            <label>Minimum Platform Fee:</label>
            <input type="text" id="min_platform_fee" name="min_platform_fee" value="" readonly><br>
            <small>80 TPS, Journey Builder Lite, Campaign Manager, CTWA - (Meta/Tiktok), Agent Assist < 20 Agents, Personalize upto 1 Million profiles and external events not supported</small><br><br>
            <label>Personalize Load:</label>
            <select name="personalize_load">
                <option value="NA" {% if inputs and inputs.personalize_load == 'NA' %}selected{% endif %}>NA</option>
                <option value="Standard" {% if inputs and inputs.personalize_load == 'Standard' %}selected{% endif %}>Standard - upto 5 million records, no external events</option>
                <option value="Advanced" {% if inputs and inputs.personalize_load == 'Advanced' %}selected{% endif %}>Advanced - 10 million records, external events supported</option>
            </select><br>
            <small>If the client requires large number of profiles and support for external events, select the appropriate tier.</small><br><br>
            <label>BFSI Tier:</label>
            <select name="bfsi_tier">
                <option value="NA" {% if inputs and inputs.bfsi_tier == 'NA' %}selected{% endif %}>NA</option>
                <option value="Tier 1" {% if inputs and inputs.bfsi_tier == 'Tier 1' %}selected{% endif %}>Tier 1</option>
                <option value="Tier 2" {% if inputs and inputs.bfsi_tier == 'Tier 2' %}selected{% endif %}>Tier 2</option>
                <option value="Tier 3" {% if inputs and inputs.bfsi_tier == 'Tier 3' %}selected{% endif %}>Tier 3</option>
            </select><br>
            <small>Each tier comes with specific controls of privacy and security requirements. The exact inclusions of each tier will be displayed on the final pricing page.</small><br><br>
            <label>AI Module (Yes/No):</label>
            <select name="ai_module">
                <option value="NA" {% if inputs and inputs.ai_module == 'NA' %}selected{% endif %}>NA</option>
                <option value="Yes" {% if inputs and inputs.ai_module == 'Yes' %}selected{% endif %}>Yes</option>
                <option value="No" {% if inputs and inputs.ai_module == 'No' %}selected{% endif %}>No</option>
            </select><br>
            <small>Access to Workspace Configuration and data retraining screens</small><br><br>
            <label>Smart CPaaS:</label>
            <select name="smart_cpaas">
                <option value="No" {% if inputs and inputs.smart_cpaas == 'No' %}selected{% endif %}>No</option>
                <option value="Yes" {% if inputs and inputs.smart_cpaas == 'Yes' %}selected{% endif %}>Yes</option>
            </select><br>
            <small>Auto failover between channels</small><br><br>
            <label>Increased TPS:</label>
            <select name="increased_tps">
                <option value="NA" {% if inputs and inputs.increased_tps == 'NA' %}selected{% endif %}>NA</option>
                <option value="250" {% if inputs and inputs.increased_tps == '250' %}selected{% endif %}>250 (upto 250 Messages per Second)</option>
                <option value="1000" {% if inputs and inputs.increased_tps == '1000' %}selected{% endif %}>1000 (upto 1000 Messages per Second)</option>
            </select><br>
            <small>Required to support high volume campaigns</small><br><br>
            <label>Number of Human Agents (Agent Assist):</label>
            <select name="human_agents">
                <option value="NA" {% if inputs and inputs.human_agents == 'NA' %}selected{% endif %}>NA</option>
                <option value="20+" {% if inputs and inputs.human_agents == '20+' %}selected{% endif %}>20+</option>
                <option value="50+" {% if inputs and inputs.human_agents == '50+' %}selected{% endif %}>50+</option>
                <option value="100+" {% if inputs and inputs.human_agents == '100+' %}selected{% endif %}>100+</option>
            </select><br><br>
            <input type="submit" value="Next: Rate Card">
        </form>
      </div>
    </div>
    <script>
    function updateMinPlatformFee() {
        var country = document.getElementById('country-select').value;
        var minFee = '';
        if (country === 'India') minFee = 'INR 100000';
        else if (country === 'Africa' || country === 'Rest of the World') minFee = 'USD 500';
        else minFee = 'USD 1000';
        document.getElementById('min_platform_fee').value = minFee;
    }
    window.onload = updateMinPlatformFee;
    
    // Format input with commas as user types
    document.querySelectorAll('.comma-number').forEach(function(input) {
        input.addEventListener('input', function(e) {
            var cursor = input.selectionStart;
            var oldLength = input.value.length;
            input.value = addCommas(input.value);
            var newLength = input.value.length;
            input.selectionEnd = cursor + (newLength - oldLength);
        });
    });
    // Remove commas before submit
    document.getElementById('volumes-form').addEventListener('submit', function(e) {
        document.querySelectorAll('.comma-number').forEach(function(input) {
            input.value = input.value.replace(/,/g, '');
        });
    });
    </script>
    {% endif %}

    {% if step == 'prices' %}
    <!-- DEBUG: In prices section -->
    <form method="post" id="prices-form">
        <h2>Rate Card Pricing</h2>
        <p>Review and adjust the suggested prices if needed. These prices will be used to calculate your final pricing.</p>
        <label>Platform Fee (editable):</label>
        {{ currency_symbol }}<input type="text" name="platform_fee" class="comma-number" value="{{ platform_fee }}" required><br>
        <small>This is the calculated platform fee based on your selections. You can edit it if needed.</small><br><br>
        <label>AI Message Rate Card:</label>
        {{ currency_symbol }}<input type="text" name="ai_price" class="comma-number" value="{{ suggested.ai_price }}" required><br><br>
        <label>Advanced Message Rate Card:</label>
        {{ currency_symbol }}<input type="text" name="advanced_price" class="comma-number" value="{{ suggested.advanced_price }}" required><br><br>
        <label>Basic Marketing Message Rate Card:</label>
        {{ currency_symbol }}<input type="text" name="basic_marketing_price" class="comma-number" value="{{ suggested.basic_marketing_price }}" required><br><br>
        <label>Basic Utility/Authentication Message Rate Card:</label>
        {{ currency_symbol }}<input type="text" name="basic_utility_price" class="comma-number" value="{{ suggested.basic_utility_price }}" required><br><br>
        <input type="submit" value="Calculate Results">
    </form>
    <form method="get">
        <input type="submit" value="Back to Volumes">
    </form>
    <script>
    // Format input with commas as user types
    document.querySelectorAll('.comma-number').forEach(function(input) {
        input.addEventListener('input', function(e) {
            var cursor = input.selectionStart;
            var oldLength = input.value.length;
            input.value = addCommas(input.value);
            var newLength = input.value.length;
            input.selectionEnd = cursor + (newLength - oldLength);
        });
    });
    // Remove commas before submit
    document.getElementById('prices-form').addEventListener('submit', function(e) {
        document.querySelectorAll('.comma-number').forEach(function(input) {
            input.value = input.value.replace(/,/g, '');
        });
    });
    </script>
    {% endif %}

    {% if step == 'bundle' %}
    <!-- DEBUG: In bundle section -->
    {% set all_volumes_zero = (inputs.ai_volume|float == 0 and inputs.advanced_volume|float == 0 and inputs.basic_marketing_volume|float == 0 and inputs.basic_utility_volume|float == 0) %}
    <!-- DEBUG: all_volumes_zero: {{ all_volumes_zero }} -->
    {% if all_volumes_zero %}
    <form method="post">
        <h2>Enter Committed Monthly Amount</h2>
        <p>You have not entered any message volumes. Please enter the amount you wish to commit per month. This amount will be drawn down as you use the platform, based on the agreed rates for each message type.</p>
        <label>Committed Amount ({{ currency_symbol }}):</label>
        <input type="text" name="committed_amount" class="comma-number" required><br><br>
        <input type="hidden" name="step" value="bundle">
        <input type="submit" value="Continue">
    </form>
    {% endif %}
    {% endif %}

    {% if step == 'results' %}
        <!-- DEBUG: Step is results -->
        <!-- DEBUG: pricing_table exists: {{ pricing_table is defined }} -->
        <!-- DEBUG: pricing_table length: {{ pricing_table|length if pricing_table else 'None' }} -->
        <!-- DEBUG: final_inclusions exists: {{ final_inclusions is defined }} -->
        <!-- DEBUG: final_inclusions length: {{ final_inclusions|length if final_inclusions else 'None' }} -->
        <!-- DEBUG: expected_invoice_amount: {{ expected_invoice_amount }} -->
        <!-- DEBUG: currency_symbol: {{ currency_symbol }} -->
        
        <h1>RESULTS PAGE</h1>
        <p>Step: {{ step }}</p>
        <p>Currency: {{ currency_symbol }}</p>
        <p>Expected Invoice Amount: {{ expected_invoice_amount }}</p>
        
        {% if pricing_table %}
            <h2>Pricing Table ({{ pricing_table|length }} items)</h2>
            <ul>
            {% for row in pricing_table %}
                <li>{{ row.line_item or row.label }} - {{ row.chosen_price }}</li>
            {% endfor %}
            </ul>
        {% else %}
            <p>No pricing table available</p>
        {% endif %}
        
        {% if final_inclusions %}
            <h2>Inclusions ({{ final_inclusions|length }} items)</h2>
            <ul>
            {% for inc in final_inclusions %}
                <li>{{ inc }}</li>
            {% endfor %}
            </ul>
        {% else %}
            <p>No inclusions available</p>
        {% endif %}
        
        <form method="get" action="/" style="margin-top: 32px; text-align: center;">
            <input type="submit" value="Start Over">
        </form>
    {% endif %}

    {% if step != 'volumes' %}
    <form method="post" style="display:inline;" onsubmit="event.preventDefault(); alert('Coming soon'); return false;">
        <input type="hidden" name="step" value="volumes">
        <input type="submit" value="Edit Volumes" disabled style="opacity:0.5; cursor:not-allowed;">
    </form>
    {% endif %}
    {% if step != 'prices' %}
    <form method="post" style="display:inline;" onsubmit="event.preventDefault(); alert('Coming soon'); return false;">
        <input type="hidden" name="step" value="prices">
        <input type="submit" value="Edit Prices" disabled style="opacity:0.5; cursor:not-allowed;">
    </form>
    {% endif %}
    
    <!-- DEBUG SECTION -->
    <div style="background: #f0f0f0; border: 1px solid #ccc; padding: 10px; margin-top: 20px; font-family: monospace; font-size: 12px;">
        <strong>DEBUG INFO:</strong><br>
        Step: {{ step }}<br>
        Step type: {{ step.__class__.__name__ if step else 'None' }}<br>
        {% if step == 'results' %}
            Pricing table exists: {{ pricing_table is defined }}<br>
            Pricing table length: {{ pricing_table|length if pricing_table else 'None' }}<br>
            Final inclusions exists: {{ final_inclusions is defined }}<br>
            Final inclusions length: {{ final_inclusions|length if final_inclusions else 'None' }}<br>
            Expected invoice amount: {{ expected_invoice_amount }}<br>
            Currency symbol: {{ currency_symbol }}<br>
        {% endif %}
        {% if inputs %}
            Inputs exist: true<br>
            Country: {{ inputs.country if inputs.country else 'None' }}<br>
        {% else %}
            Inputs exist: false<br>
        {% endif %}
    </div>
</body>
</html>