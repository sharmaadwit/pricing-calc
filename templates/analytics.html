{% if not authorized %}
  <h2>Enter Analytics Access Keyword</h2>
  <form method="post">
    <input type="password" name="keyword" placeholder="Secret keyword" required>
    <input type="submit" value="Access Analytics">
  </form>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <ul class="flashes">
        {% for category, message in messages %}
          <li class="{{ category }}">{{ message }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}
{% else %}
  <h2>Analytics Dashboard</h2>
  <ul>
    <li><b>Total Calculations:</b> {{ analytics.calculations }}</li>
    <li><b>Calculations by Day:</b>
      <ul>
        {% for day, count in analytics.calculations_by_day.items() %}
          <li>{{ day }}: {{ count }}</li>
        {% endfor %}
      </ul>
    </li>
    <li><b>Calculations by Week:</b>
      <ul>
        {% for week, count in analytics.calculations_by_week.items() %}
          <li>{{ week }}: {{ count }}</li>
        {% endfor %}
      </ul>
    </li>
    <li><b>Most Common Countries:</b>
      <ul>
        {% for country, count in analytics.country_counter.most_common(5) %}
          <li>{{ country }}: {{ count }}</li>
        {% endfor %}
      </ul>
    </li>
    <li><b>Most Common Platform Fee Options:</b>
      <ul>
        {% for fee, count in analytics.platform_fee_options.most_common(5) %}
          <li>{{ fee }}: {{ count }}</li>
        {% endfor %}
      </ul>
    </li>
    <li><b>Platform Fee Stats:</b>
      <ul>
        <li>Average: {{ analytics.platform_fee_entries|sum / (analytics.platform_fee_entries|length or 1) }}</li>
        <li>Min: {{ analytics.platform_fee_entries|min }}</li>
        <li>Max: {{ analytics.platform_fee_entries|max }}</li>
        <li>Median: {% set sorted = analytics.platform_fee_entries|sort %}{{ sorted[sorted|length // 2] if sorted else 'N/A' }}</li>
      </ul>
    </li>
    <li><b>Message Volume Distribution:</b>
      <ul>
        <li>AI: {{ analytics.message_volumes.ai }}</li>
        <li>Advanced: {{ analytics.message_volumes.advanced }}</li>
        <li>Basic Marketing: {{ analytics.message_volumes.basic_marketing }}</li>
        <li>Basic Utility: {{ analytics.message_volumes.basic_utility }}</li>
      </ul>
    </li>
    <li><b>Discount Warnings Triggered:</b>
      <ul>
        {% for msg, count in analytics.discount_warnings.items() %}
          <li>{{ msg }}: {{ count }}</li>
        {% endfor %}
      </ul>
    </li>
    <li><b>Platform Fee Discount Triggered:</b> {{ analytics.platform_fee_discount_triggered }}</li>
    <li><b>Average Margin (Chosen):</b> {{ analytics.margin_chosen|sum / (analytics.margin_chosen|length or 1) }}%</li>
    <li><b>Average Margin (Rate Card):</b> {{ analytics.margin_rate_card|sum / (analytics.margin_rate_card|length or 1) }}%</li>
  </ul>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  {% set countries = analytics.stats.keys() %}
  {% for country in countries %}
    <h3>Country: {{ country }}</h3>
    <table border="1" cellpadding="5" style="border-collapse: collapse; margin-bottom: 1em;">
      <thead>
        <tr>
          <th>Type</th>
          <th>Average</th>
          <th>Min</th>
          <th>Max</th>
          <th>Median</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><b>Platform Fee</b></td>
          <td>{{ analytics.stats[country]['platform_fee']['avg'] }}</td>
          <td>{{ analytics.stats[country]['platform_fee']['min'] }}</td>
          <td>{{ analytics.stats[country]['platform_fee']['max'] }}</td>
          <td>{{ analytics.stats[country]['platform_fee']['median'] }}</td>
        </tr>
        <tr>
          <td>AI Message</td>
          <td>{{ analytics.stats[country]['msg_types']['ai']['avg'] }}</td>
          <td>{{ analytics.stats[country]['msg_types']['ai']['min'] }}</td>
          <td>{{ analytics.stats[country]['msg_types']['ai']['max'] }}</td>
          <td>{{ analytics.stats[country]['msg_types']['ai']['median'] }}</td>
        </tr>
        <tr>
          <td>Advanced Message</td>
          <td>{{ analytics.stats[country]['msg_types']['advanced']['avg'] }}</td>
          <td>{{ analytics.stats[country]['msg_types']['advanced']['min'] }}</td>
          <td>{{ analytics.stats[country]['msg_types']['advanced']['max'] }}</td>
          <td>{{ analytics.stats[country]['msg_types']['advanced']['median'] }}</td>
        </tr>
        <tr>
          <td>Basic Marketing Message</td>
          <td>{{ analytics.stats[country]['msg_types']['basic_marketing']['avg'] }}</td>
          <td>{{ analytics.stats[country]['msg_types']['basic_marketing']['min'] }}</td>
          <td>{{ analytics.stats[country]['msg_types']['basic_marketing']['max'] }}</td>
          <td>{{ analytics.stats[country]['msg_types']['basic_marketing']['median'] }}</td>
        </tr>
        <tr>
          <td>Basic Utility</td>
          <td>{{ analytics.stats[country]['msg_types']['basic_utility']['avg'] }}</td>
          <td>{{ analytics.stats[country]['msg_types']['basic_utility']['min'] }}</td>
          <td>{{ analytics.stats[country]['msg_types']['basic_utility']['max'] }}</td>
          <td>{{ analytics.stats[country]['msg_types']['basic_utility']['median'] }}</td>
        </tr>
      </tbody>
    </table>
    <div>
      <canvas id="msgPriceChart_{{ country|replace(' ', '_') }}" width="400" height="200"></canvas>
      <script>
        var ctx_{{ country|replace(' ', '_') }} = document.getElementById('msgPriceChart_{{ country|replace(' ', '_') }}').getContext('2d');
        var msgTypes_{{ country|replace(' ', '_') }} = ['AI', 'Advanced', 'Basic Marketing', 'Basic Utility'];
        var avgPrices_{{ country|replace(' ', '_') }} = {{ [
            (analytics.avg_price_data[country]['ai']['sum'] / (analytics.avg_price_data[country]['ai']['count'] or 1))|round(4),
            (analytics.avg_price_data[country]['advanced']['sum'] / (analytics.avg_price_data[country]['advanced']['count'] or 1))|round(4),
            (analytics.avg_price_data[country]['basic_marketing']['sum'] / (analytics.avg_price_data[country]['basic_marketing']['count'] or 1))|round(4),
            (analytics.avg_price_data[country]['basic_utility']['sum'] / (analytics.avg_price_data[country]['basic_utility']['count'] or 1))|round(4)
          ]|tojson }};
        new Chart(ctx_{{ country|replace(' ', '_') }}, {
          type: 'bar',
          data: {
            labels: msgTypes_{{ country|replace(' ', '_') }},
            datasets: [{
              label: 'Avg Price per Message',
              data: avgPrices_{{ country|replace(' ', '_') }},
              backgroundColor: ['#2196f3', '#4caf50', '#ff9800', '#9c27b0']
            }]
          },
          options: {
            scales: { y: { beginAtZero: true } },
            plugins: { legend: { display: false } }
          }
        });
      </script>
      <p>
        <b>Avg AI:</b> {{ (analytics.avg_price_data[country]['ai']['sum'] / (analytics.avg_price_data[country]['ai']['count'] or 1))|round(4) }}<br>
        <b>Avg Advanced:</b> {{ (analytics.avg_price_data[country]['advanced']['sum'] / (analytics.avg_price_data[country]['advanced']['count'] or 1))|round(4) }}<br>
        <b>Avg Basic Marketing:</b> {{ (analytics.avg_price_data[country]['basic_marketing']['sum'] / (analytics.avg_price_data[country]['basic_marketing']['count'] or 1))|round(4) }}<br>
        <b>Avg Basic Utility:</b> {{ (analytics.avg_price_data[country]['basic_utility']['sum'] / (analytics.avg_price_data[country]['basic_utility']['count'] or 1))|round(4) }}
      </p>
    </div>
    <div>
      <canvas id="platformFeeChart_{{ country|replace(' ', '_') }}" width="400" height="100"></canvas>
      <script>
        var ctx2_{{ country|replace(' ', '_') }} = document.getElementById('platformFeeChart_{{ country|replace(' ', '_') }}').getContext('2d');
        var avgPlatformFee_{{ country|replace(' ', '_') }} = {{ (analytics.avg_platform_fee_data[country]['sum'] / (analytics.avg_platform_fee_data[country]['count'] or 1))|round(2) }};
        new Chart(ctx2_{{ country|replace(' ', '_') }}, {
          type: 'bar',
          data: {
            labels: ['Platform Fee'],
            datasets: [{
              label: 'Avg Platform Fee',
              data: [avgPlatformFee_{{ country|replace(' ', '_') }}],
              backgroundColor: ['#f44336']
            }]
          },
          options: {
            scales: { y: { beginAtZero: true } },
            plugins: { legend: { display: false } }
          }
        });
      </script>
      <p><b>Avg Platform Fee:</b> {{ (analytics.avg_platform_fee_data[country]['sum'] / (analytics.avg_platform_fee_data[country]['count'] or 1))|round(2) }}</p>
    </div>
    <hr>
  {% endfor %}
{% endif %} 