{% if not authorized %}
  <h2>Enter Analytics Access Keyword</h2>
  <form method="post">
    <input type="password" name="keyword" placeholder="Secret keyword" required>
    <input type="submit" value="Access Analytics">
  </form>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <ul class="flashes">
        {% for category, message in messages %}
          <li class="{{ category }}">{{ message }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}
{% else %}
  <h2>Analytics Dashboard</h2>
  <ul>
    <li><b>Total Calculations:</b> {{ analytics.calculations }}</li>
    <li><b>Calculations by Day:</b>
      <ul>
        {% for day, count in analytics.calculations_by_day.items() %}
          <li>{{ day }}: {{ count }}</li>
        {% endfor %}
      </ul>
    </li>
    <li><b>Calculations by Week:</b>
      <ul>
        {% for week, count in analytics.calculations_by_week.items() %}
          <li>{{ week }}: {{ count }}</li>
        {% endfor %}
      </ul>
    </li>
    <li><b>Most Common Countries:</b>
      <ul>
        {% for country, count in analytics.country_counter %}
          <li>{{ country }}: {{ count }}</li>
        {% endfor %}
      </ul>
    </li>
    <li><b>Most Common Platform Fee Options:</b>
      <ul>
        {% for fee, count in analytics.platform_fee_options %}
          <li>{{ fee }}: {{ count }}</li>
        {% endfor %}
      </ul>
    </li>
    <li><b>Discount Warnings Triggered:</b>
      <ul>
        {% if analytics.discount_warnings and analytics.discount_warnings|length > 0 %}
          {% for msg, count in analytics.discount_warnings.items() %}
            <li>{{ msg }}: {{ count }}</li>
          {% endfor %}
        {% else %}
          <li>No discount warnings.</li>
        {% endif %}
      </ul>
    </li>
    <li><b>Platform Fee Discount Triggered:</b> {{ analytics.platform_fee_discount_triggered }}</li>
    <li><b>Average Margin (Chosen):</b> {{ analytics.margin_chosen|sum / (analytics.margin_chosen|length or 1) }}%</li>
    <li><b>Average Margin (Rate Card):</b> {{ analytics.margin_rate_card|sum / (analytics.margin_rate_card|length or 1) }}%</li>
    <li><b>Top 5 Users (by Calculations):</b>
      <ul>
        {% for user, count in analytics.top_users %}
          <li>{{ user }}: {{ count }}</li>
        {% endfor %}
      </ul>
    </li>
  </ul>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  {% if analytics.stats %}
    {% for country, stat in analytics.stats.items() %}
      <h3>Country: {{ country }}</h3>
      <table border="1" cellpadding="5" style="border-collapse: collapse; margin-bottom: 1em;">
        <thead>
          <tr>
            <th>Type</th>
            <th>Average</th>
            <th>Min</th>
            <th>Max</th>
            <th>Median</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><b>Platform Fee</b></td>
            <td>{{ stat['platform_fee']['avg']|round(2)|int if stat['platform_fee']['avg'] % 1 == 0 else stat['platform_fee']['avg']|round(2) }}</td>
            <td>{{ stat['platform_fee']['min']|round(2)|int if stat['platform_fee']['min'] % 1 == 0 else stat['platform_fee']['min']|round(2) }}</td>
            <td>{{ stat['platform_fee']['max']|round(2)|int if stat['platform_fee']['max'] % 1 == 0 else stat['platform_fee']['max']|round(2) }}</td>
            <td>{{ stat['platform_fee']['median']|round(2)|int if stat['platform_fee']['median'] % 1 == 0 else stat['platform_fee']['median']|round(2) }}</td>
          </tr>
          <tr>
            <td>AI Message</td>
            <td>{{ stat['msg_types']['ai']['avg']|round(2)|int if stat['msg_types']['ai']['avg'] % 1 == 0 else stat['msg_types']['ai']['avg']|round(2) }}</td>
            <td>{{ stat['msg_types']['ai']['min']|round(2)|int if stat['msg_types']['ai']['min'] % 1 == 0 else stat['msg_types']['ai']['min']|round(2) }}</td>
            <td>{{ stat['msg_types']['ai']['max']|round(2)|int if stat['msg_types']['ai']['max'] % 1 == 0 else stat['msg_types']['ai']['max']|round(2) }}</td>
            <td>{{ stat['msg_types']['ai']['median']|round(2)|int if stat['msg_types']['ai']['median'] % 1 == 0 else stat['msg_types']['ai']['median']|round(2) }}</td>
          </tr>
          <tr>
            <td>Advanced Message</td>
            <td>{{ stat['msg_types']['advanced']['avg']|round(2)|int if stat['msg_types']['advanced']['avg'] % 1 == 0 else stat['msg_types']['advanced']['avg']|round(2) }}</td>
            <td>{{ stat['msg_types']['advanced']['min']|round(2)|int if stat['msg_types']['advanced']['min'] % 1 == 0 else stat['msg_types']['advanced']['min']|round(2) }}</td>
            <td>{{ stat['msg_types']['advanced']['max']|round(2)|int if stat['msg_types']['advanced']['max'] % 1 == 0 else stat['msg_types']['advanced']['max']|round(2) }}</td>
            <td>{{ stat['msg_types']['advanced']['median']|round(2)|int if stat['msg_types']['advanced']['median'] % 1 == 0 else stat['msg_types']['advanced']['median']|round(2) }}</td>
          </tr>
          <tr>
            <td>Basic Marketing Message</td>
            <td>{{ stat['msg_types']['basic_marketing']['avg']|round(2)|int if stat['msg_types']['basic_marketing']['avg'] % 1 == 0 else stat['msg_types']['basic_marketing']['avg']|round(2) }}</td>
            <td>{{ stat['msg_types']['basic_marketing']['min']|round(2)|int if stat['msg_types']['basic_marketing']['min'] % 1 == 0 else stat['msg_types']['basic_marketing']['min']|round(2) }}</td>
            <td>{{ stat['msg_types']['basic_marketing']['max']|round(2)|int if stat['msg_types']['basic_marketing']['max'] % 1 == 0 else stat['msg_types']['basic_marketing']['max']|round(2) }}</td>
            <td>{{ stat['msg_types']['basic_marketing']['median']|round(2)|int if stat['msg_types']['basic_marketing']['median'] % 1 == 0 else stat['msg_types']['basic_marketing']['median']|round(2) }}</td>
          </tr>
          <tr>
            <td>Basic Utility</td>
            <td>{{ stat['msg_types']['basic_utility']['avg']|round(2)|int if stat['msg_types']['basic_utility']['avg'] % 1 == 0 else stat['msg_types']['basic_utility']['avg']|round(2) }}</td>
            <td>{{ stat['msg_types']['basic_utility']['min']|round(2)|int if stat['msg_types']['basic_utility']['min'] % 1 == 0 else stat['msg_types']['basic_utility']['min']|round(2) }}</td>
            <td>{{ stat['msg_types']['basic_utility']['max']|round(2)|int if stat['msg_types']['basic_utility']['max'] % 1 == 0 else stat['msg_types']['basic_utility']['max']|round(2) }}</td>
            <td>{{ stat['msg_types']['basic_utility']['median']|round(2)|int if stat['msg_types']['basic_utility']['median'] % 1 == 0 else stat['msg_types']['basic_utility']['median']|round(2) }}</td>
          </tr>
        </tbody>
      </table>
      <div>
        <canvas id="msgPriceChart_{{ country|replace(' ', '_') }}" width="150" height="60"></canvas>
        <script>
          var ctx_{{ country|replace(' ', '_') }} = document.getElementById('msgPriceChart_{{ country|replace(' ', '_') }}').getContext('2d');
          var msgTypes_{{ country|replace(' ', '_') }} = ['AI', 'Advanced', 'Basic Marketing', 'Basic Utility'];
          var avgPrices_{{ country|replace(' ', '_') }} = {{ [
              (analytics.avg_price_data[country]['ai']['sum'] / (analytics.avg_price_data[country]['ai']['count'] or 1))|round(4),
              (analytics.avg_price_data[country]['advanced']['sum'] / (analytics.avg_price_data[country]['advanced']['count'] or 1))|round(4),
              (analytics.avg_price_data[country]['basic_marketing']['sum'] / (analytics.avg_price_data[country]['basic_marketing']['count'] or 1))|round(4),
              (analytics.avg_price_data[country]['basic_utility']['sum'] / (analytics.avg_price_data[country]['basic_utility']['count'] or 1))|round(4)
            ]|tojson }};
          new Chart(ctx_{{ country|replace(' ', '_') }}, {
            type: 'bar',
            data: {
              labels: msgTypes_{{ country|replace(' ', '_') }},
              datasets: [{
                label: 'Avg Price per Message',
                data: avgPrices_{{ country|replace(' ', '_') }},
                backgroundColor: ['#2196f3', '#4caf50', '#ff9800', '#9c27b0']
              }]
            },
            options: {
              scales: { y: { beginAtZero: true } },
              plugins: { legend: { display: false } }
            }
          });
        </script>
        <p>
          <b>Avg AI:</b> {{ (analytics.avg_price_data[country]['ai']['sum'] / (analytics.avg_price_data[country]['ai']['count'] or 1))|round(4) }}<br>
          <b>Avg Advanced:</b> {{ (analytics.avg_price_data[country]['advanced']['sum'] / (analytics.avg_price_data[country]['advanced']['count'] or 1))|round(4) }}<br>
          <b>Avg Basic Marketing:</b> {{ (analytics.avg_price_data[country]['basic_marketing']['sum'] / (analytics.avg_price_data[country]['basic_marketing']['count'] or 1))|round(4) }}<br>
          <b>Avg Basic Utility:</b> {{ (analytics.avg_price_data[country]['basic_utility']['sum'] / (analytics.avg_price_data[country]['basic_utility']['count'] or 1))|round(4) }}
        </p>
      </div>
      <div>
        <canvas id="platformFeeChart_{{ country|replace(' ', '_') }}" width="150" height="60"></canvas>
        <script>
          var ctx2_{{ country|replace(' ', '_') }} = document.getElementById('platformFeeChart_{{ country|replace(' ', '_') }}').getContext('2d');
          var avgPlatformFee_{{ country|replace(' ', '_') }} = {{ (analytics.avg_platform_fee_data[country]['sum'] / (analytics.avg_platform_fee_data[country]['count'] or 1))|round(2) }};
          new Chart(ctx2_{{ country|replace(' ', '_') }}, {
            type: 'bar',
            data: {
              labels: ['Platform Fee'],
              datasets: [{
                label: 'Avg Platform Fee',
                data: [avgPlatformFee_{{ country|replace(' ', '_') }}],
                backgroundColor: ['#f44336']
              }]
            },
            options: {
              scales: { y: { beginAtZero: true } },
              plugins: { legend: { display: false } }
            }
          });
        </script>
        <p><b>Avg Platform Fee:</b> {{ (analytics.avg_platform_fee_data[country]['sum'] / (analytics.avg_platform_fee_data[country]['count'] or 1))|round(2) }}</p>
      </div>
      <hr>
    {% endfor %}
  {% else %}
    <p>No analytics data available yet.</p>
  {% endif %}

  {% if analytics.user_stats %}
    <h2>User-wise Statistics</h2>
    {% for user, stats_by_group in analytics.user_stats.items() %}
      <h3>User: {{ user }}</h3>
      <table border="1" cellpadding="5" style="border-collapse: collapse; margin-bottom: 1em;">
        <thead>
          <tr>
            <th>Type</th>
            {% for (country, currency), stat in stats_by_group.items() %}
              <th colspan="4">{{ country }} ({{ currency }})</th>
            {% endfor %}
          </tr>
          <tr>
            <th></th>
            {% for (country, currency), stat in stats_by_group.items() %}
              <th>Avg</th><th>Min</th><th>Max</th><th>Median</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for label, key in [('Platform Fee', 'platform_fee'), ('AI Message', 'ai'), ('Advanced Message', 'advanced'), ('Basic Marketing Message', 'basic_marketing'), ('Basic Utility', 'basic_utility')] %}
            <tr>
              <td><b>{{ label }}</b></td>
              {% for (country, currency), stat in stats_by_group.items() %}
                <td>{{ stat[key]['avg']|round(2)|int if stat[key]['avg'] % 1 == 0 else stat[key]['avg']|round(2) }}</td>
                <td>{{ stat[key]['min']|round(2)|int if stat[key]['min'] % 1 == 0 else stat[key]['min']|round(2) }}</td>
                <td>{{ stat[key]['max']|round(2)|int if stat[key]['max'] % 1 == 0 else stat[key]['max']|round(2) }}</td>
                <td>{{ stat[key]['median']|round(2)|int if stat[key]['median'] % 1 == 0 else stat[key]['median']|round(2) }}</td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endfor %}
  {% endif %}
{% endif %} 