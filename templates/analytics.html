{% macro fmt_num(val) %}
  {%- if val is number -%}
    {%- if val % 1 == 0 -%}{{ '{:,}'.format(val|int) }}{%- else -%}{{ '{:,.2f}'.format(val) }}{%- endif -%}
  {%- else -%}{{ val }}{%- endif -%}
{% endmacro %}

{% if not authorized %}
  <h2>Enter Analytics Access Keyword</h2>
  <form method="post">
    <input type="password" name="keyword" placeholder="Secret keyword" required>
    <input type="submit" value="Access Analytics">
  </form>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <ul class="flashes">
        {% for category, message in messages %}
          <li class="{{ category }}">{{ message }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}
{% else %}
  <h2>Analytics Dashboard</h2>
  <ul>
    <li><b>Total Calculations:</b> {{ analytics.calculations }}</li>
    <li><b>Calculations by Day:</b>
      <ul>
        {% for day, count in analytics.calculations_by_day.items() %}
          <li>{{ day }}: {{ count }}</li>
        {% endfor %}
      </ul>
    </li>
    <li><b>Calculations by Week:</b>
      <ul>
        {% for week, count in analytics.calculations_by_week.items() %}
          <li>{{ week }}: {{ count }}</li>
        {% endfor %}
      </ul>
    </li>
    <li><b>Most Common Countries:</b>
      <ul>
        {% for country, count in analytics.country_counter %}
          <li>{{ country }}: {{ count }}</li>
        {% endfor %}
      </ul>
    </li>
    <li><b>Most Common Platform Fee Options:</b>
      <ul>
        {% for fee, count in analytics.platform_fee_options %}
          {# Find the most common currency for this fee #}
          {% set fee_currency = None %}
          {% for a in analytics.get('all_analytics', []) %}
            {% if a.platform_fee == fee and a.currency and not fee_currency %}
              {% set fee_currency = a.currency %}
            {% endif %}
          {% endfor %}
          <li>{{ fee_currency if fee_currency else currency_symbol }}{{ '{:,.2f}'.format(fee|float) }}: {{ count }}</li>
        {% endfor %}
      </ul>
    </li>
    <li><b>Discount Warnings Triggered:</b>
      <ul>
        {% if analytics.discount_warnings and analytics.discount_warnings|length > 0 %}
          {% for msg, count in analytics.discount_warnings.items() %}
            <li>{{ msg }}: {{ count }}</li>
          {% endfor %}
        {% else %}
          <li>No discount warnings.</li>
        {% endif %}
      </ul>
    </li>
    <li><b>Platform Fee Discount Triggered:</b> {{ analytics.platform_fee_discount_triggered }}</li>
    <li><b>Average Margin (Chosen):</b> {{ analytics.margin_chosen|sum / (analytics.margin_chosen|length or 1) }}%
      <br><span style="font-size:0.97em; color:#444;">This is the average margin based on the actual prices you entered (Chosen Prices), including platform fee and all message types.</span>
    </li>
    <li><b>Average Margin (Rate Card):</b> {{ analytics.margin_rate_card|sum / (analytics.margin_rate_card|length or 1) }}%
      <br><span style="font-size:0.97em; color:#444;">This is the average margin if all prices were set at the default rate card (no discounts), including platform fee and all message types.</span>
    </li>
    <li><b>Top 5 Users (by Calculations):</b>
      <ul>
        {% for user, count in analytics.top_users %}
          <li>{{ user }}: {{ count }}</li>
        {% endfor %}
      </ul>
    </li>
  </ul>

  {% if analytics.stats %}
    {% for country, stat in analytics.stats.items() %}
      <h3>Country: {{ country }}</h3>
      <table border="1" cellpadding="5" style="border-collapse: collapse; margin-bottom: 1em;">
        <thead>
          <tr>
            <th>Type</th>
            <th>Average</th>
            <th>Min</th>
            <th>Max</th>
            <th>Median</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><b>Platform Fee</b></td>
            <td>{{ stat['platform_fee']['avg']|round(2)|int if stat['platform_fee']['avg'] % 1 == 0 else stat['platform_fee']['avg']|round(2) }}</td>
            <td>{{ stat['platform_fee']['min']|round(2)|int if stat['platform_fee']['min'] % 1 == 0 else stat['platform_fee']['min']|round(2) }}</td>
            <td>{{ stat['platform_fee']['max']|round(2)|int if stat['platform_fee']['max'] % 1 == 0 else stat['platform_fee']['max']|round(2) }}</td>
            <td>{{ stat['platform_fee']['median']|round(2)|int if stat['platform_fee']['median'] % 1 == 0 else stat['platform_fee']['median']|round(2) }}</td>
          </tr>
          <tr>
            <td>AI Message</td>
            <td>{{ stat['msg_types']['ai']['avg']|round(2)|int if stat['msg_types']['ai']['avg'] % 1 == 0 else stat['msg_types']['ai']['avg']|round(2) }}</td>
            <td>{{ stat['msg_types']['ai']['min']|round(2)|int if stat['msg_types']['ai']['min'] % 1 == 0 else stat['msg_types']['ai']['min']|round(2) }}</td>
            <td>{{ stat['msg_types']['ai']['max']|round(2)|int if stat['msg_types']['ai']['max'] % 1 == 0 else stat['msg_types']['ai']['max']|round(2) }}</td>
            <td>{{ stat['msg_types']['ai']['median']|round(2)|int if stat['msg_types']['ai']['median'] % 1 == 0 else stat['msg_types']['ai']['median']|round(2) }}</td>
          </tr>
          <tr>
            <td>Advanced Message</td>
            <td>{{ stat['msg_types']['advanced']['avg']|round(2)|int if stat['msg_types']['advanced']['avg'] % 1 == 0 else stat['msg_types']['advanced']['avg']|round(2) }}</td>
            <td>{{ stat['msg_types']['advanced']['min']|round(2)|int if stat['msg_types']['advanced']['min'] % 1 == 0 else stat['msg_types']['advanced']['min']|round(2) }}</td>
            <td>{{ stat['msg_types']['advanced']['max']|round(2)|int if stat['msg_types']['advanced']['max'] % 1 == 0 else stat['msg_types']['advanced']['max']|round(2) }}</td>
            <td>{{ stat['msg_types']['advanced']['median']|round(2)|int if stat['msg_types']['advanced']['median'] % 1 == 0 else stat['msg_types']['advanced']['median']|round(2) }}</td>
          </tr>
          <tr>
            <td>Basic Marketing Message</td>
            <td>{{ stat['msg_types']['basic_marketing']['avg']|round(2)|int if stat['msg_types']['basic_marketing']['avg'] % 1 == 0 else stat['msg_types']['basic_marketing']['avg']|round(2) }}</td>
            <td>{{ stat['msg_types']['basic_marketing']['min']|round(2)|int if stat['msg_types']['basic_marketing']['min'] % 1 == 0 else stat['msg_types']['basic_marketing']['min']|round(2) }}</td>
            <td>{{ stat['msg_types']['basic_marketing']['max']|round(2)|int if stat['msg_types']['basic_marketing']['max'] % 1 == 0 else stat['msg_types']['basic_marketing']['max']|round(2) }}</td>
            <td>{{ stat['msg_types']['basic_marketing']['median']|round(2)|int if stat['msg_types']['basic_marketing']['median'] % 1 == 0 else stat['msg_types']['basic_marketing']['median']|round(2) }}</td>
          </tr>
          <tr>
            <td>Basic Utility</td>
            <td>{{ stat['msg_types']['basic_utility']['avg']|round(2)|int if stat['msg_types']['basic_utility']['avg'] % 1 == 0 else stat['msg_types']['basic_utility']['avg']|round(2) }}</td>
            <td>{{ stat['msg_types']['basic_utility']['min']|round(2)|int if stat['msg_types']['basic_utility']['min'] % 1 == 0 else stat['msg_types']['basic_utility']['min']|round(2) }}</td>
            <td>{{ stat['msg_types']['basic_utility']['max']|round(2)|int if stat['msg_types']['basic_utility']['max'] % 1 == 0 else stat['msg_types']['basic_utility']['max']|round(2) }}</td>
            <td>{{ stat['msg_types']['basic_utility']['median']|round(2)|int if stat['msg_types']['basic_utility']['median'] % 1 == 0 else stat['msg_types']['basic_utility']['median']|round(2) }}</td>
          </tr>
        </tbody>
      </table>
      <hr>
    {% endfor %}
  {% else %}
    <p>No analytics data available yet.</p>
  {% endif %}

  {% if analytics.user_stats %}
    <h2>User-wise Statistics</h2>
    {% for user, stats_by_group in analytics.user_stats.items() %}
      <h3>User: {{ user }}</h3>
      <table border="1" cellpadding="5" style="border-collapse: collapse; margin-bottom: 1em;">
        <thead>
          <tr>
            <th>Type</th>
            {% for (country, currency), stat in stats_by_group.items() %}
              <th colspan="4">{{ country }} ({{ currency }})</th>
            {% endfor %}
          </tr>
          <tr>
            <th></th>
            {% for (country, currency), stat in stats_by_group.items() %}
              <th>Avg</th><th>Min</th><th>Max</th><th>Median</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for label, key in [('Platform Fee', 'platform_fee'), ('AI Message', 'ai'), ('Advanced Message', 'advanced'), ('Basic Marketing Message', 'basic_marketing'), ('Basic Utility', 'basic_utility')] %}
            <tr>
              <td><b>{{ label }}</b></td>
              {% for (country, currency), stat in stats_by_group.items() %}
                <td>{{ fmt_num(stat[key]['avg']) }}</td>
                <td>{{ fmt_num(stat[key]['min']) }}</td>
                <td>{{ fmt_num(stat[key]['max']) }}</td>
                <td>{{ fmt_num(stat[key]['median']) }}</td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endfor %}
  {% endif %}

  {% if analytics.discounts %}
    <h2>Discount Analytics</h2>
    <table border="1" cellpadding="5" style="border-collapse: collapse; margin-bottom: 1em;">
      <thead>
        <tr>
          <th>Type</th>
          <th>Avg Discount (%)</th>
          <th>Min</th>
          <th>Max</th>
          <th>Median</th>
          <th>Distribution (0-10%, 10-20%, ...)</th>
        </tr>
      </thead>
      <tbody>
        {% for label, key in [('AI', 'ai'), ('Advanced', 'advanced'), ('Marketing', 'marketing'), ('Utility', 'utility')] %}
        <tr>
          <td>{{ label }}</td>
          <td>{{ analytics.discounts[key].avg|round(2) }}</td>
          <td>{{ analytics.discounts[key].min|round(2) }}</td>
          <td>{{ analytics.discounts[key].max|round(2) }}</td>
          <td>{{ analytics.discounts[key].median|round(2) }}</td>
          <td>
            {% for count in analytics.discounts[key].buckets %}
              <span style="display:inline-block; width:18px; text-align:center;">{{ count }}</span>
            {% endfor %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  {% if analytics.modes %}
    <h2>Most Common Prices (Mode)</h2>
    <ul>
      {% set all_analytics = analytics.get('all_analytics', []) %}
      {% macro get_currency(type_key) %}
        {%- set currency = None -%}
        {%- for a in all_analytics -%}
          {%- if type_key == 'ai' and a.ai_price == analytics.modes.ai and a.currency -%}
            {%- set currency = a.currency -%}
          {%- elif type_key == 'advanced' and a.advanced_price == analytics.modes.advanced and a.currency -%}
            {%- set currency = a.currency -%}
          {%- elif type_key == 'marketing' and a.basic_marketing_price == analytics.modes.marketing and a.currency -%}
            {%- set currency = a.currency -%}
          {%- elif type_key == 'utility' and a.basic_utility_price == analytics.modes.utility and a.currency -%}
            {%- set currency = a.currency -%}
          {%- elif type_key == 'platform_fee' and a.platform_fee == analytics.modes.platform_fee and a.currency -%}
            {%- set currency = a.currency -%}
          {%- endif -%}
        {%- endfor -%}
        {{ currency if currency else currency_symbol }}
      {% endmacro %}
      {% macro fmt_val(val) %}
        {%- if val is number -%}
          {%- if val % 1 == 0 -%}{{ '{:,}'.format(val|int) }}{%- else -%}{{ '{:,.2f}'.format(val) }}{%- endif -%}
        {%- else -%}{{ val }}{%- endif -%}
      {% endmacro %}
      <li>AI: {{ get_currency('ai') }}{{ fmt_val(analytics.modes.ai) }}</li>
      <li>Advanced: {{ get_currency('advanced') }}{{ fmt_val(analytics.modes.advanced) }}</li>
      <li>Marketing: {{ get_currency('marketing') }}{{ fmt_val(analytics.modes.marketing) }}</li>
      <li>Utility: {{ get_currency('utility') }}{{ fmt_val(analytics.modes.utility) }}</li>
      <li>Platform Fee: {{ get_currency('platform_fee') }}{{ fmt_val(analytics.modes.platform_fee) }}</li>
    </ul>
  {% endif %}

  {% if analytics.popular_types %}
    <h2>Popular Message Types (by Total Volume)</h2>
    <ul>
      {% for label, vol in analytics.popular_types %}
        {%- set currency = None -%}
        {%- for a in analytics.get('all_analytics', []) -%}
          {%- if label == 'AI' and a.ai_volume == vol and a.currency -%}
            {%- set currency = a.currency -%}
          {%- elif label == 'Advanced' and a.advanced_volume == vol and a.currency -%}
            {%- set currency = a.currency -%}
          {%- elif label == 'Marketing' and a.basic_marketing_volume == vol and a.currency -%}
            {%- set currency = a.currency -%}
          {%- elif label == 'Utility' and a.basic_utility_volume == vol and a.currency -%}
            {%- set currency = a.currency -%}
          {%- endif -%}
        {%- endfor -%}
        <li>{{ label }}: {{ currency if currency else currency_symbol }}{{ fmt_val(vol) }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  {% if analytics.platform_fee_vs_deal_correlation is not none %}
    <h2>Platform Fee vs. Deal Size Correlation</h2>
    <p>Pearson correlation coefficient: <b>{{ analytics.platform_fee_vs_deal_correlation|round(3) }}</b> (1 = perfect positive, 0 = none, -1 = perfect negative)</p>
  {% endif %}

  {% if analytics.seasonality %}
    <h2>Seasonality (Calculations by Month)</h2>
    <ul>
      {% for month, count in analytics.seasonality.items() %}
        <li>{{ month }}: {{ count }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endif %} 